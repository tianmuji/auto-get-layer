<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ å®Œæ•´å±‚æ¬¡åŒ–åˆ†ç»„ç®—æ³•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .content {
            padding: 30px;
        }

        .demo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .demo-panel {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e2e8f0;
        }

        .panel-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .canvas {
            position: relative;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            height: 500px;
            margin: 15px 0;
            overflow: hidden;
        }

        .element {
            position: absolute;
            border: 2px solid;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            cursor: pointer;
            z-index: 10;
            transition: all 0.3s ease;
        }

        .element:hover {
            transform: scale(1.05);
            z-index: 20;
        }

        .element-container { background-color: #4299e1; border-color: #3182ce; }
        .element-text { background-color: #ed8936; border-color: #dd6b20; }
        .element-button { background-color: #9f7aea; border-color: #805ad5; }
        .element-image { background-color: #48bb78; border-color: #38a169; }
        .element-normal { background-color: #38b2ac; border-color: #319795; }

        .group-boundary {
            position: absolute;
            border: 1px solid;
            background: transparent;
            border-radius: 4px;
            pointer-events: none;
            z-index: 5;
            opacity: 0.7;
        }

        /* ç®€åŒ–çš„å±‚æ¬¡é¢œè‰² - åªæ˜¾ç¤ºå…³é”®å±‚çº§ */
        .group-boundary.page {
            border-color: #1f2937;
            border-width: 3px;
            border-style: solid;
            background: rgba(31, 41, 55, 0.08);
            z-index: 1;
        }
        .group-boundary.section {
            border-color: #dc2626;
            border-width: 2px;
            border-style: dashed;
            background: rgba(220, 38, 38, 0.05);
            z-index: 2;
        }
        .group-boundary.article {
            border-color: #ea580c;
            border-width: 2px;
            border-style: dashed;
            background: rgba(234, 88, 12, 0.05);
            z-index: 3;
        }
        .group-boundary.header {
            border-color: #d97706;
            border-width: 1px;
            border-style: dotted;
            background: transparent;
            z-index: 4;
        }
        .group-boundary.nav {
            border-color: #ca8a04;
            border-width: 1px;
            border-style: dotted;
            background: transparent;
            z-index: 5;
        }
        .group-boundary.main {
            border-color: #65a30d;
            border-width: 2px;
            border-style: dashed;
            background: rgba(101, 163, 13, 0.05);
            z-index: 6;
        }
        .group-boundary.aside {
            border-color: #059669;
            border-width: 1px;
            border-style: dotted;
            background: transparent;
            z-index: 7;
        }
        .group-boundary.div {
            border-color: #0891b2;
            border-width: 1px;
            border-style: dotted;
            background: transparent;
            z-index: 8;
        }
        .group-boundary.component {
            border-color: #0284c7;
            border-width: 1px;
            border-style: dotted;
            background: transparent;
            z-index: 9;
        }

        .group-label {
            position: absolute;
            top: -10px;
            left: 4px;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.65em;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            opacity: 0.9;
        }

        /* åªä¸ºé‡è¦å±‚çº§æ˜¾ç¤ºæ ‡ç­¾ */
        .group-label.page { background: #1f2937; }
        .group-label.section { background: #dc2626; }
        .group-label.article { background: #ea580c; }
        .group-label.main { background: #65a30d; }

        /* å…¶ä»–å±‚çº§çš„æ ‡ç­¾æ›´å°æ›´é€æ˜ */
        .group-label.header { background: #d97706; opacity: 0.7; font-size: 0.6em; }
        .group-label.nav { background: #ca8a04; opacity: 0.7; font-size: 0.6em; }
        .group-label.aside { background: #059669; opacity: 0.7; font-size: 0.6em; }
        .group-label.div { background: #0891b2; opacity: 0.6; font-size: 0.55em; }
        .group-label.component { background: #0284c7; opacity: 0.6; font-size: 0.55em; }

        .controls {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
        }

        .control-label {
            font-weight: 600;
            min-width: 120px;
        }

        .slider {
            flex: 1;
            max-width: 200px;
        }

        .value-display {
            min-width: 60px;
            font-weight: 600;
            color: #3b82f6;
        }

        .test-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }

        .test-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #3b82f6;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .test-btn:hover {
            background: #2563eb;
        }

        .test-btn.active {
            background: #1d4ed8;
        }

        .results-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            margin-top: 20px;
        }

        .group-tree {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            line-height: 1.6;
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            max-height: 500px;
            overflow-y: auto;
        }

        /* äº¤äº’å¼æ ‘èŠ‚ç‚¹æ ·å¼ */
        .tree-node {
            margin: 2px 0;
            user-select: none;
        }

        .node-content {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .node-content:hover {
            background: #f3f4f6;
            transform: translateX(2px);
        }

        .node-toggle {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 6px;
            border-radius: 3px;
            background: #e5e7eb;
            color: #6b7280;
            font-size: 10px;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .node-toggle:hover {
            background: #d1d5db;
        }

        .node-toggle.expanded {
            background: #3b82f6;
            color: white;
        }

        .node-toggle.leaf {
            background: transparent;
            cursor: default;
            color: #9ca3af;
        }

        .node-icon {
            margin-right: 6px;
            font-size: 14px;
        }

        .node-label {
            font-weight: 500;
            color: #1f2937;
            flex: 1;
            font-size: 13px;
        }

        .node-count {
            background: #e5e7eb;
            color: #6b7280;
            padding: 1px 6px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 6px;
        }

        .node-children {
            margin-left: 24px;
            border-left: 1px solid #e5e7eb;
            padding-left: 8px;
            display: none;
            animation: slideDown 0.2s ease;
        }

        .node-children.expanded {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ä¸åŒå±‚çº§çš„æ ·å¼ */
        .node-content.page { background: #f9fafb; border-left: 3px solid #1f2937; font-weight: 700; }
        .node-content.section { background: #fef2f2; border-left: 3px solid #dc2626; font-weight: 600; }
        .node-content.article { background: #fff7ed; border-left: 3px solid #ea580c; font-weight: 600; }
        .node-content.header { background: #fffbeb; border-left: 3px solid #d97706; font-weight: 600; }
        .node-content.nav { background: #fefce8; border-left: 3px solid #ca8a04; }
        .node-content.main { background: #f7fee7; border-left: 3px solid #65a30d; }
        .node-content.aside { background: #ecfdf5; border-left: 3px solid #059669; }
        .node-content.div { background: #f0f9ff; border-left: 3px solid #0891b2; }
        .node-content.component { background: #eff6ff; border-left: 3px solid #0284c7; }

        /* åŸå§‹ç»“æ„æ ·å¼ */
        .node-content.flat { background: #fafafa; border-left: 3px solid #9ca3af; color: #6b7280; }
        .node-content.element { background: #f8fafc; border-left: 2px solid #64748b; font-size: 0.85em; }

        /* æ ‘å½¢å¯¹æ¯”ç½‘æ ¼ */
        .tree-comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }

        .tree-panel {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e2e8f0;
        }

        .tree-panel-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        /* æ§åˆ¶æŒ‰é’®æ ·å¼ */
        .control-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: #3b82f6;
            color: white;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .control-btn.secondary {
            background: #6b7280;
        }

        .control-btn.secondary:hover {
            background: #4b5563;
        }



        .stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #3b82f6;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .legend {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #e2e8f0;
        }

        .legend-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #1f2937;
        }

        .legend-items {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 2px solid;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ å®Œæ•´å±‚æ¬¡åŒ–åˆ†ç»„ç®—æ³•</h1>
            <p>å‚è€ƒWebæ ‡å‡†ï¼Œç¡®ä¿æ‰€æœ‰å…ƒç´ éƒ½è¢«åˆ†ç»„ï¼Œä»é¡µé¢çº§åˆ°ç»„ä»¶çº§çš„å®Œæ•´å±‚æ¬¡</p>
        </div>

        <div class="content">
            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="controls">
                <h3 style="margin-bottom: 15px;">ğŸ§ª æµ‹è¯•ç”¨ä¾‹é€‰æ‹©</h3>

                <div class="test-buttons">
                    <button class="test-btn active" data-case="simple_card">ğŸƒ ç®€å•å¡ç‰‡</button>
                    <button class="test-btn" data-case="basic_layout">ğŸ“„ åŸºç¡€å¸ƒå±€</button>
                    <button class="test-btn" data-case="form_example">ğŸ“ è¡¨å•ç¤ºä¾‹</button>
                    <button class="test-btn" data-case="navigation_bar">ğŸ§­ å¯¼èˆªæ </button>
                    <button class="test-btn" data-case="dashboard_simple">ğŸ“Š ç®€å•ä»ªè¡¨æ¿</button>
                    <button class="test-btn" data-case="figma_cs_enterprise">ğŸ¨ Figmaå®é™…æ¡ˆä¾‹</button>
                </div>

                <!-- æ ¡éªŒæŒ‰é’® -->
                <div style="margin-top: 15px;">
                    <button onclick="validateAllCases()" style="background: #10b981; color: white; padding: 8px 16px; border: none; border-radius: 4px; margin-right: 10px;">âœ… æ ¡éªŒæ‰€æœ‰ç”¨ä¾‹</button>
                    <button onclick="testFunction()" style="background: #ef4444; color: white; padding: 8px 16px; border: none; border-radius: 4px; margin-right: 10px;">ğŸ”§ æ ¡éªŒå½“å‰ç”¨ä¾‹</button>
                        <button onclick="copyErrorsToClipboard()" style="background: #8b5cf6; color: white; padding: 8px 16px; border: none; border-radius: 4px;">ğŸ“‹ å¤åˆ¶é”™è¯¯ä¿¡æ¯</button>
                </div>
            </div>

                    <!-- é”™è¯¯ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ -->
                    <div id="error-output" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; display: none;">
                    </div>





            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-elements">0</div>
                    <div class="stat-label">æ€»å…ƒç´ æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-groups">0</div>
                    <div class="stat-label">åˆ†ç»„æ€»æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="coverage-rate">0%</div>
                    <div class="stat-label">è¦†ç›–ç‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="max-depth">0</div>
                    <div class="stat-label">æœ€å¤§æ·±åº¦</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avg-group-size">0</div>
                    <div class="stat-label">å¹³å‡ç»„å¤§å°</div>
                </div>
            </div>

            <!-- æ¼”ç¤ºåŒºåŸŸ -->
            <div class="demo-grid">
                <div class="demo-panel">
                    <div class="panel-title">ğŸ“¥ åŸå§‹å…ƒç´ å¸ƒå±€</div>
                    <div class="canvas" id="original-canvas"></div>
                </div>
                
                <div class="demo-panel">
                    <div class="panel-title">ğŸŒ å®Œæ•´å±‚æ¬¡åŒ–åˆ†ç»„</div>
                    <div class="canvas" id="grouped-canvas"></div>
                </div>
            </div>

            <!-- æ ‘å½¢ç»“æ„æ§åˆ¶ -->
            <div class="results-panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>ğŸŒ³ äº¤äº’å¼æ ‘å½¢ç»“æ„å¯¹æ¯”</h3>
                    <div style="display: flex; gap: 10px;">
                        <button class="control-btn" id="expand-all-btn">ğŸ“‚ å…¨éƒ¨å±•å¼€</button>
                        <button class="control-btn" id="collapse-all-btn">ğŸ“ å…¨éƒ¨æ”¶èµ·</button>
                        <button class="control-btn secondary" id="refresh-btn">ğŸ”„ é‡æ–°åˆ†æ</button>
                    </div>
                </div>

                <!-- æ ‘å½¢ç»“æ„å¯¹æ¯” -->
                <div class="tree-comparison-grid">
                    <div class="tree-panel">
                        <div class="tree-panel-title">ğŸ”´ åˆ†ç»„å‰ç»“æ„ (æ‰å¹³)</div>
                        <div class="group-tree" id="original-tree"></div>
                    </div>

                    <div class="tree-panel">
                        <div class="tree-panel-title">ğŸŒ³ åˆ†ç»„åç»“æ„ (å±‚æ¬¡åŒ–)</div>
                        <div class="group-tree" id="grouped-tree"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="grouping-utils.js"></script>
    <script>
        // æµ‹è¯•æ•°æ®é›† - ä»ç®€å•åˆ°å¤æ‚çš„æ¸è¿›å¼ä¾‹å­
        const testCases = {
            // 1. ğŸƒ ç®€å•å¡ç‰‡ - æœ€åŸºç¡€çš„åˆ†ç»„ç¤ºä¾‹
            simple_card: [
                { id: 'card_title', name: 'ç”¨æˆ·ä¿¡æ¯', x: 20, y: 20, width: 200, height: 30, type: 'text' },
                { id: 'avatar', name: 'å¤´åƒ', x: 30, y: 60, width: 60, height: 60, type: 'image' },
                { id: 'username', name: 'å¼ ä¸‰', x: 100, y: 70, width: 100, height: 20, type: 'text' },
                { id: 'email', name: 'zhang@email.com', x: 100, y: 95, width: 120, height: 15, type: 'text' },
                { id: 'edit_btn', name: 'ç¼–è¾‘', x: 160, y: 130, width: 60, height: 25, type: 'button' }
            ],

            // 2. ğŸ“„ åŸºç¡€å¸ƒå±€ - ç®€å•çš„é¡µé¢ç»“æ„
            basic_layout: [
                // å¤´éƒ¨åŒºåŸŸ
                { id: 'logo', name: 'Logo', x: 20, y: 10, width: 80, height: 30, type: 'image' },
                { id: 'nav_home', name: 'é¦–é¡µ', x: 120, y: 15, width: 50, height: 20, type: 'button' },
                { id: 'nav_about', name: 'å…³äº', x: 180, y: 15, width: 50, height: 20, type: 'button' },

                // ä¸»è¦å†…å®¹
                { id: 'main_title', name: 'æ¬¢è¿ä½¿ç”¨', x: 20, y: 60, width: 300, height: 40, type: 'text' },
                { id: 'content_text', name: 'è¿™æ˜¯ä¸»è¦å†…å®¹åŒºåŸŸ...', x: 20, y: 110, width: 280, height: 60, type: 'text' },
                { id: 'cta_button', name: 'å¼€å§‹ä½¿ç”¨', x: 20, y: 180, width: 100, height: 35, type: 'button' },

                // ä¾§è¾¹æ 
                { id: 'sidebar_title', name: 'ç›¸å…³é“¾æ¥', x: 340, y: 60, width: 120, height: 25, type: 'text' },
                { id: 'link1', name: 'å¸®åŠ©æ–‡æ¡£', x: 350, y: 95, width: 80, height: 20, type: 'button' },
                { id: 'link2', name: 'è”ç³»æˆ‘ä»¬', x: 350, y: 125, width: 80, height: 20, type: 'button' }
            ],

            // 3. ğŸ“ è¡¨å•ç¤ºä¾‹ - å±•ç¤ºè¡¨å•å…ƒç´ çš„åˆ†ç»„
            form_example: [
                { id: 'form_title', name: 'ç”¨æˆ·æ³¨å†Œ', x: 50, y: 20, width: 200, height: 30, type: 'text' },

                // åŸºæœ¬ä¿¡æ¯ç»„
                { id: 'basic_label', name: 'åŸºæœ¬ä¿¡æ¯', x: 50, y: 70, width: 100, height: 20, type: 'text' },
                { id: 'name_label', name: 'å§“å:', x: 60, y: 100, width: 50, height: 15, type: 'text' },
                { id: 'name_input', name: 'å§“åè¾“å…¥æ¡†', x: 120, y: 95, width: 150, height: 25, type: 'text' },
                { id: 'email_label', name: 'é‚®ç®±:', x: 60, y: 130, width: 50, height: 15, type: 'text' },
                { id: 'email_input', name: 'é‚®ç®±è¾“å…¥æ¡†', x: 120, y: 125, width: 150, height: 25, type: 'text' },

                // å¯†ç ä¿¡æ¯ç»„
                { id: 'pwd_label', name: 'å¯†ç è®¾ç½®', x: 50, y: 170, width: 100, height: 20, type: 'text' },
                { id: 'password_label', name: 'å¯†ç :', x: 60, y: 200, width: 50, height: 15, type: 'text' },
                { id: 'password_input', name: 'å¯†ç è¾“å…¥æ¡†', x: 120, y: 195, width: 150, height: 25, type: 'text' },
                { id: 'confirm_label', name: 'ç¡®è®¤:', x: 60, y: 230, width: 50, height: 15, type: 'text' },
                { id: 'confirm_input', name: 'ç¡®è®¤å¯†ç æ¡†', x: 120, y: 225, width: 150, height: 25, type: 'text' },

                // æ“ä½œæŒ‰é’®ç»„
                { id: 'submit_btn', name: 'æ³¨å†Œ', x: 120, y: 270, width: 70, height: 30, type: 'button' },
                { id: 'cancel_btn', name: 'å–æ¶ˆ', x: 200, y: 270, width: 70, height: 30, type: 'button' }
            ],

            // 4. ğŸ§­ å¯¼èˆªæ  - æ°´å¹³å¸ƒå±€çš„åˆ†ç»„ç¤ºä¾‹
            navigation_bar: [
                // å·¦ä¾§å“ç‰ŒåŒº
                { id: 'brand_logo', name: 'Logo', x: 20, y: 15, width: 40, height: 30, type: 'image' },
                { id: 'brand_name', name: 'æˆ‘çš„ç½‘ç«™', x: 70, y: 20, width: 80, height: 20, type: 'text' },

                // ä¸­é—´å¯¼èˆªèœå•
                { id: 'nav_home', name: 'é¦–é¡µ', x: 200, y: 20, width: 50, height: 20, type: 'button' },
                { id: 'nav_products', name: 'äº§å“', x: 260, y: 20, width: 50, height: 20, type: 'button' },
                { id: 'nav_services', name: 'æœåŠ¡', x: 320, y: 20, width: 50, height: 20, type: 'button' },
                { id: 'nav_about', name: 'å…³äº', x: 380, y: 20, width: 50, height: 20, type: 'button' },

                // å³ä¾§ç”¨æˆ·åŒº
                { id: 'search_box', name: 'æœç´¢', x: 480, y: 18, width: 100, height: 24, type: 'text' },
                { id: 'login_btn', name: 'ç™»å½•', x: 590, y: 18, width: 50, height: 24, type: 'button' },
                { id: 'signup_btn', name: 'æ³¨å†Œ', x: 650, y: 18, width: 50, height: 24, type: 'button' }
            ],

            // 5. ğŸ“Š ç®€å•ä»ªè¡¨æ¿ - å¤šåŒºåŸŸå¸ƒå±€ç¤ºä¾‹
            dashboard_simple: [
                // é¡¶éƒ¨æ ‡é¢˜æ 
                { id: 'dash_title', name: 'æ•°æ®ä»ªè¡¨æ¿', x: 20, y: 20, width: 200, height: 30, type: 'text' },
                { id: 'refresh_btn', name: 'åˆ·æ–°', x: 500, y: 25, width: 60, height: 20, type: 'button' },

                // ç»Ÿè®¡å¡ç‰‡åŒºåŸŸ
                { id: 'card1_title', name: 'æ€»ç”¨æˆ·', x: 20, y: 70, width: 120, height: 20, type: 'text' },
                { id: 'card1_value', name: '1,234', x: 20, y: 95, width: 120, height: 35, type: 'text' },
                { id: 'card1_trend', name: '+12%', x: 20, y: 135, width: 120, height: 15, type: 'text' },

                { id: 'card2_title', name: 'é”€å”®é¢', x: 160, y: 70, width: 120, height: 20, type: 'text' },
                { id: 'card2_value', name: 'Â¥56,789', x: 160, y: 95, width: 120, height: 35, type: 'text' },
                { id: 'card2_trend', name: '+8%', x: 160, y: 135, width: 120, height: 15, type: 'text' },

                { id: 'card3_title', name: 'è®¢å•æ•°', x: 300, y: 70, width: 120, height: 20, type: 'text' },
                { id: 'card3_value', name: '456', x: 300, y: 95, width: 120, height: 35, type: 'text' },
                { id: 'card3_trend', name: '+15%', x: 300, y: 135, width: 120, height: 15, type: 'text' },

                // å›¾è¡¨åŒºåŸŸ
                { id: 'chart_title', name: 'é”€å”®è¶‹åŠ¿', x: 20, y: 180, width: 400, height: 25, type: 'text' },
                { id: 'chart_area', name: 'å›¾è¡¨å†…å®¹', x: 20, y: 210, width: 400, height: 150, type: 'container' },

                // æœ€è¿‘æ´»åŠ¨
                { id: 'activity_title', name: 'æœ€è¿‘æ´»åŠ¨', x: 450, y: 70, width: 150, height: 25, type: 'text' },
                { id: 'activity1', name: 'æ–°ç”¨æˆ·æ³¨å†Œ', x: 450, y: 105, width: 150, height: 20, type: 'text' },
                { id: 'activity2', name: 'è®¢å•å®Œæˆ', x: 450, y: 130, width: 150, height: 20, type: 'text' },
                { id: 'activity3', name: 'æ”¯ä»˜æˆåŠŸ', x: 450, y: 155, width: 150, height: 20, type: 'text' }
            ],

            // 6. ğŸ¨ Figmaå®é™…æ¡ˆä¾‹ - CSä¼ä¸šç‰ˆç•Œé¢
            figma_cs_enterprise: []
        };

        // å…¨å±€å˜é‡
        let currentCase = 'simple_card';
        let currentGroups = [];

        // ğŸ¨ Figmaæ•°æ®è½¬æ¢å‡½æ•°
        function convertFigmaToElements(figmaData) {
            console.log('ğŸ¨ å¼€å§‹è½¬æ¢Figmaæ•°æ®...');
            const elements = [];

            function extractElements(node, parentBounds = null, depth = 0) {
                console.log(`${'  '.repeat(depth)}ğŸ” å¤„ç†èŠ‚ç‚¹: ${node.name} (${node.type})`);

                // å¦‚æœèŠ‚ç‚¹æœ‰è¾¹ç•Œæ¡†ï¼Œå°†å…¶ä½œä¸ºå…ƒç´ æ·»åŠ 
                if (node.boundingBox && node.boundingBox.width > 5 && node.boundingBox.height > 5) {
                    const element = {
                        id: node.id,
                        name: node.name || 'Unnamed',
                        x: Math.round(node.boundingBox.x),
                        y: Math.round(node.boundingBox.y),
                        width: Math.round(node.boundingBox.width),
                        height: Math.round(node.boundingBox.height),
                        type: determineFigmaElementType(node),
                        figmaType: node.type
                    };

                    elements.push(element);
                    console.log(`${'  '.repeat(depth)}ğŸ“¦ æå–å…ƒç´ : ${element.name} (${element.x},${element.y},${element.width}Ã—${element.height}) [${element.type}]`);
                }

                // é€’å½’å¤„ç†å­èŠ‚ç‚¹
                if (node.children && node.children.length > 0) {
                    node.children.forEach(child => extractElements(child, node.boundingBox, depth + 1));
                }
            }

            // ä»nodesæ•°ç»„ä¸­æå–å…ƒç´ 
            if (figmaData.nodes && figmaData.nodes.length > 0) {
                figmaData.nodes.forEach(node => extractElements(node, null, 0));
            }

            console.log(`âœ… è½¬æ¢å®Œæˆï¼Œå…±æå– ${elements.length} ä¸ªå…ƒç´ `);
            return elements;
        }

        function determineFigmaElementType(node) {
            const nodeType = node.type?.toLowerCase() || '';
            const nodeName = node.name?.toLowerCase() || '';

            // æ ¹æ®FigmaèŠ‚ç‚¹ç±»å‹åˆ¤æ–­
            if (nodeType.includes('text')) return 'text';
            if (nodeType.includes('image') || nodeType.includes('svg')) return 'image';
            if (nodeType.includes('frame') || nodeType.includes('group')) return 'container';
            if (nodeType.includes('instance') || nodeType.includes('component')) return 'button';
            if (nodeType.includes('rectangle') || nodeType.includes('ellipse')) return 'container';

            // æ ¹æ®èŠ‚ç‚¹åç§°åˆ¤æ–­
            if (nodeName.includes('button') || nodeName.includes('btn')) return 'button';
            if (nodeName.includes('text') || nodeName.includes('label')) return 'text';
            if (nodeName.includes('image') || nodeName.includes('icon') || nodeName.includes('logo')) return 'image';

            return 'normal';
        }

        // ğŸ¨ FigmaåŸå§‹æ•°æ®
        const figmaRawData = {
            "metadata": {
                "name": "CSä¼ä¸šç‰ˆ (Copy)",
                "lastModified": "2025-07-04T15:39:12Z"
            },
            "nodes": [
                {
                    "id": "16237:70560",
                    "name": "Frame 427319817",
                    "type": "FRAME",
                    "children": [
                        {
                            "id": "16237:70561",
                            "name": "é‚€è¯·æˆå‘˜æŒ‰é’®",
                            "type": "FRAME",
                            "boundingBox": {
                                "x": 10,
                                "y": 10,
                                "width": 100,
                                "height": 40
                            },
                            "children": [
                                {
                                    "id": "16237:70562",
                                    "name": "Frame 8",
                                    "type": "FRAME",
                                    "boundingBox": {
                                        "x": 15,
                                        "y": 15,
                                        "width": 90,
                                        "height": 30
                                    },
                                    "children": [
                                        {
                                            "id": "16237:70563",
                                            "name": "é‚€è¯·å›¾æ ‡",
                                            "type": "INSTANCE",
                                            "boundingBox": {
                                                "x": 20,
                                                "y": 20,
                                                "width": 16,
                                                "height": 16
                                            }
                                        },
                                        {
                                            "id": "16237:70564",
                                            "name": "é‚€è¯·æˆå‘˜",
                                            "type": "TEXT",
                                            "boundingBox": {
                                                "x": 40,
                                                "y": 22,
                                                "width": 60,
                                                "height": 16
                                            }
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            "id": "16237:70565",
                            "name": "æ‰¹å¯¼å…¥æŒ‰é’®",
                            "type": "FRAME",
                            "boundingBox": {
                                "x": 120,
                                "y": 10,
                                "width": 120,
                                "height": 40
                            },
                            "children": [
                                {
                                    "id": "16237:70566",
                                    "name": "Frame 8",
                                    "type": "FRAME",
                                    "boundingBox": {
                                        "x": 125,
                                        "y": 15,
                                        "width": 110,
                                        "height": 30
                                    },
                                    "children": [
                                        {
                                            "id": "16237:70567",
                                            "name": "å¯¼å…¥å›¾æ ‡",
                                            "type": "INSTANCE",
                                            "boundingBox": {
                                                "x": 130,
                                                "y": 20,
                                                "width": 16,
                                                "height": 16
                                            }
                                        },
                                        {
                                            "id": "16237:70568",
                                            "name": "æ‰¹å¯¼å…¥æˆå‘˜",
                                            "type": "TEXT",
                                            "boundingBox": {
                                                "x": 150,
                                                "y": 22,
                                                "width": 80,
                                                "height": 16
                                            }
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            "id": "16237:70569",
                            "name": "å¯¼å‡ºæŒ‰é’®",
                            "type": "FRAME",
                            "boundingBox": {
                                "x": 250,
                                "y": 10,
                                "width": 140,
                                "height": 40
                            },
                            "children": [
                                {
                                    "id": "16237:70570",
                                    "name": "Frame 8",
                                    "type": "FRAME",
                                    "boundingBox": {
                                        "x": 255,
                                        "y": 15,
                                        "width": 130,
                                        "height": 30
                                    },
                                    "children": [
                                        {
                                            "id": "16237:70571",
                                            "name": "å¯¼å‡ºå›¾æ ‡",
                                            "type": "INSTANCE",
                                            "boundingBox": {
                                                "x": 260,
                                                "y": 20,
                                                "width": 16,
                                                "height": 16
                                            }
                                        },
                                        {
                                            "id": "16237:70572",
                                            "name": "å¯¼å‡ºæˆå‘˜åˆ—è¡¨",
                                            "type": "TEXT",
                                            "boundingBox": {
                                                "x": 280,
                                                "y": 22,
                                                "width": 100,
                                                "height": 16
                                            }
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            "id": "16237:70573",
                            "name": "æé†’æŒ‰é’®",
                            "type": "FRAME",
                            "boundingBox": {
                                "x": 400,
                                "y": 10,
                                "width": 120,
                                "height": 40
                            },
                            "children": [
                                {
                                    "id": "16237:70574",
                                    "name": "Frame 8",
                                    "type": "FRAME",
                                    "boundingBox": {
                                        "x": 405,
                                        "y": 15,
                                        "width": 110,
                                        "height": 30
                                    },
                                    "children": [
                                        {
                                            "id": "16237:70575",
                                            "name": "æé†’å›¾æ ‡",
                                            "type": "INSTANCE",
                                            "boundingBox": {
                                                "x": 410,
                                                "y": 20,
                                                "width": 16,
                                                "height": 16
                                            }
                                        },
                                        {
                                            "id": "16237:70576",
                                            "name": "æ‰¹é‡æé†’",
                                            "type": "TEXT",
                                            "boundingBox": {
                                                "x": 430,
                                                "y": 22,
                                                "width": 80,
                                                "height": 16
                                            }
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ]
        };









        // æ¸²æŸ“å‡½æ•°
        function renderCanvas(elements, canvasId) {
            const canvas = document.getElementById(canvasId);
            canvas.innerHTML = '';

            if (!elements || elements.length === 0) return;

            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
            const maxX = Math.max(...elements.map(e => e.x + e.width));
            const maxY = Math.max(...elements.map(e => e.y + e.height));
            const scale = Math.min(canvas.clientWidth / maxX, canvas.clientHeight / maxY, 1) * 0.9;

            elements.forEach(element => {
                const div = document.createElement('div');
                div.className = `element element-${element.type}`;
                div.style.left = (element.x * scale) + 'px';
                div.style.top = (element.y * scale) + 'px';
                div.style.width = (element.width * scale) + 'px';
                div.style.height = (element.height * scale) + 'px';
                div.textContent = element.name.length > 8 ? element.name.substring(0, 8) + '...' : element.name;
                div.title = `${element.name}\nä½ç½®: (${element.x}, ${element.y})\nå°ºå¯¸: ${element.width} Ã— ${element.height}`;
                canvas.appendChild(div);
            });
        }

        function renderGroupBoundaries(group, canvasId, scale) {
            const canvas = document.getElementById(canvasId);

            function renderGroup(currentGroup) {
                // æ¸²æŸ“å½“å‰åˆ†ç»„è¾¹ç•Œ
                const boundary = document.createElement('div');
                boundary.className = `group-boundary ${currentGroup.type}`;
                boundary.style.left = (currentGroup.bounds.x * scale) + 'px';
                boundary.style.top = (currentGroup.bounds.y * scale) + 'px';
                boundary.style.width = (currentGroup.bounds.width * scale) + 'px';
                boundary.style.height = (currentGroup.bounds.height * scale) + 'px';

                const label = document.createElement('div');
                label.className = `group-label ${currentGroup.type}`;
                label.textContent = currentGroup.name;
                boundary.appendChild(label);

                canvas.appendChild(boundary);

                // é€’å½’æ¸²æŸ“å­åˆ†ç»„
                currentGroup.children.forEach(child => {
                    renderGroup(child);
                });
            }

            renderGroup(group);
        }

        function renderGroupedCanvas(elements, hierarchy) {
            renderCanvas(elements, 'grouped-canvas');

            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
            const canvas = document.getElementById('grouped-canvas');
            const maxX = Math.max(...elements.map(e => e.x + e.width));
            const maxY = Math.max(...elements.map(e => e.y + e.height));
            const scale = Math.min(canvas.clientWidth / maxX, canvas.clientHeight / maxY, 1) * 0.9;

            renderGroupBoundaries(hierarchy, 'grouped-canvas', scale);
        }

        // æ¸²æŸ“åŸå§‹æ‰å¹³ç»“æ„
        function renderOriginalTree(elements) {
            const container = document.getElementById('original-tree');
            container.innerHTML = '';

            const rootNode = createTreeNode('flat', 'ğŸ“„ åŸå§‹å…ƒç´ åˆ—è¡¨', elements.length, 'root');
            container.appendChild(rootNode);

            const childrenContainer = rootNode.querySelector('.node-children');
            elements.forEach((element, index) => {
                const elementNode = createTreeNode('element', `${getElementIcon(element.type)} ${element.name}`, 0, `element_${index}`, true);
                childrenContainer.appendChild(elementNode);
            });

            // é»˜è®¤å±•å¼€æ ¹èŠ‚ç‚¹
            toggleNode('root');
        }

        // æ¸²æŸ“åˆ†ç»„åçš„å±‚æ¬¡ç»“æ„
        function renderGroupTree(group) {
            const container = document.getElementById('grouped-tree');
            container.innerHTML = '';

            function buildInteractiveTree(currentGroup, parentContainer) {
                const hasChildren = currentGroup.children.length > 0;
                const nodeId = `group_${currentGroup.id}`;

                // æ·»åŠ å¸ƒå±€æ–¹å‘å›¾æ ‡
                const directionIcon = getDirectionIcon(currentGroup.direction);
                const treeNode = createTreeNode(
                    currentGroup.type,
                    `${directionIcon} ${currentGroup.name}`,
                    currentGroup.elements.length,
                    nodeId,
                    !hasChildren
                );

                parentContainer.appendChild(treeNode);

                if (hasChildren) {
                    const childrenContainer = treeNode.querySelector('.node-children');
                    currentGroup.children.forEach(child => {
                        buildInteractiveTree(child, childrenContainer);
                    });
                } else {
                    // å¶å­èŠ‚ç‚¹æ˜¾ç¤ºå…ƒç´ åˆ—è¡¨
                    const childrenContainer = treeNode.querySelector('.node-children');
                    currentGroup.elements.forEach((element, index) => {
                        const elementNode = createTreeNode('element', `${getElementIcon(element.type)} ${element.name}`, 0, `${nodeId}_element_${index}`, true);
                        childrenContainer.appendChild(elementNode);
                    });
                }
            }

            buildInteractiveTree(group, container);

            // é»˜è®¤å±•å¼€æ ¹èŠ‚ç‚¹
            toggleNode(`group_${group.id}`);
        }

        // åˆ›å»ºäº¤äº’å¼æ ‘èŠ‚ç‚¹
        function createTreeNode(type, label, count, nodeId, isLeaf = false) {
            const treeNode = document.createElement('div');
            treeNode.className = 'tree-node';
            treeNode.innerHTML = `
                <div class="node-content ${type}">
                    <div class="node-toggle ${isLeaf ? 'leaf' : ''}" data-node-id="${nodeId}">
                        ${isLeaf ? 'â€¢' : '+'}
                    </div>
                    <span class="node-label">${label}</span>
                    ${count > 0 ? `<span class="node-count">${count}</span>` : ''}
                </div>
                <div class="node-children" id="children_${nodeId}"></div>
            `;

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            if (!isLeaf) {
                const toggle = treeNode.querySelector('.node-toggle');
                toggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleNode(nodeId);
                });
            }

            return treeNode;
        }

        // åˆ‡æ¢èŠ‚ç‚¹å±•å¼€/æ”¶èµ·çŠ¶æ€
        function toggleNode(nodeId) {
            const toggle = document.querySelector(`[data-node-id="${nodeId}"]`);
            const children = document.getElementById(`children_${nodeId}`);

            if (!toggle || !children) return;

            const isExpanded = children.classList.contains('expanded');

            if (isExpanded) {
                children.classList.remove('expanded');
                toggle.textContent = '+';
                toggle.classList.remove('expanded');
            } else {
                children.classList.add('expanded');
                toggle.textContent = 'âˆ’';
                toggle.classList.add('expanded');
            }
        }

        // å±•å¼€æ‰€æœ‰èŠ‚ç‚¹
        function expandAllNodes() {
            document.querySelectorAll('.node-toggle:not(.leaf)').forEach(toggle => {
                const nodeId = toggle.dataset.nodeId;
                const children = document.getElementById(`children_${nodeId}`);
                if (children && !children.classList.contains('expanded')) {
                    toggleNode(nodeId);
                }
            });
        }

        // æ”¶èµ·æ‰€æœ‰èŠ‚ç‚¹
        function collapseAllNodes() {
            document.querySelectorAll('.node-toggle:not(.leaf)').forEach(toggle => {
                const nodeId = toggle.dataset.nodeId;
                const children = document.getElementById(`children_${nodeId}`);
                if (children && children.classList.contains('expanded')) {
                    toggleNode(nodeId);
                }
            });
        }

        // è·å–åˆ†ç»„å›¾æ ‡
        function getGroupIcon(type) {
            const icons = {
                page: 'ğŸŒ',
                section: 'ğŸ”´',
                article: 'ğŸŸ ',
                header: 'ğŸŸ¡',
                nav: 'ğŸŸ¤',
                main: 'ğŸŸ¢',
                aside: 'ğŸ”µ',
                div: 'ğŸ”·',
                component: 'ğŸ”¹'
            };
            return icons[type] || 'ğŸ“¦';
        }

        // è·å–å…ƒç´ å›¾æ ‡
        function getElementIcon(type) {
            const icons = {
                container: 'ğŸ“¦',
                text: 'ğŸ“',
                button: 'ğŸ”˜',
                image: 'ğŸ–¼ï¸',
                normal: 'âšª'
            };
            return icons[type] || 'âšª';
        }

        // ğŸ¯ è·å–å¸ƒå±€æ–¹å‘å›¾æ ‡
        function getDirectionIcon(direction) {
            const icons = {
                'HORIZONTAL': 'â†”ï¸',  // æ¨ªå‘å¸ƒå±€
                'VERTICAL': 'â†•ï¸',    // çºµå‘å¸ƒå±€
                'NONE': 'âšª'         // å•ä¸ªå…ƒç´ 
            };
            return icons[direction] || 'â†”ï¸'; // é»˜è®¤æ¨ªå‘
        }

        function updateStats(elements, hierarchy) {
            const totalGroups = countTotalGroups(hierarchy);
            const maxDepth = getMaxDepth(hierarchy);
            const avgGroupSize = calculateAverageGroupSize(hierarchy);
            const coverageRate = 100; // æ‰€æœ‰å…ƒç´ éƒ½è¢«è¦†ç›–

            document.getElementById('total-elements').textContent = elements.length;
            document.getElementById('total-groups').textContent = totalGroups;
            document.getElementById('coverage-rate').textContent = coverageRate + '%';
            document.getElementById('max-depth').textContent = maxDepth;
            document.getElementById('avg-group-size').textContent = avgGroupSize.toFixed(1);
        }

        function countTotalGroups(group) {
            let count = 1; // å½“å‰åˆ†ç»„
            group.children.forEach(child => {
                count += countTotalGroups(child);
            });
            return count;
        }

        function getMaxDepth(group) {
            if (group.children.length === 0) return group.level;

            let maxChildDepth = 0;
            group.children.forEach(child => {
                maxChildDepth = Math.max(maxChildDepth, getMaxDepth(child));
            });

            return maxChildDepth;
        }

        function calculateAverageGroupSize(group) {
            const allGroups = [];

            function collectGroups(currentGroup) {
                allGroups.push(currentGroup);
                currentGroup.children.forEach(child => {
                    collectGroups(child);
                });
            }

            collectGroups(group);

            const totalElements = allGroups.reduce((sum, g) => sum + g.elements.length, 0);
            return totalElements / allGroups.length;
        }

        function runGrouping() {
            console.log('ğŸ”„ å¼€å§‹æ‰§è¡Œæ— é˜ˆå€¼åˆ†ç»„ç®—æ³•...');

            const elements = testCases[currentCase];
            console.log('ğŸ“Š å…ƒç´ æ•°æ®:', elements);

            if (!elements || elements.length === 0) {
                console.error('âŒ æ²¡æœ‰æ‰¾åˆ°æµ‹è¯•æ•°æ®');
                return;
            }

            const hierarchy = performCompleteHierarchicalGrouping(elements);
            console.log('ğŸ—ï¸ åˆ†ç»„ç»“æœ:', hierarchy);

            currentGroups = [hierarchy];

            try {
                renderCanvas(elements, 'original-canvas');
                console.log('âœ… åŸå§‹ç”»å¸ƒæ¸²æŸ“å®Œæˆ');

                renderGroupedCanvas(elements, hierarchy);
                console.log('âœ… åˆ†ç»„ç”»å¸ƒæ¸²æŸ“å®Œæˆ');

                renderOriginalTree(elements);
                console.log('âœ… åŸå§‹æ ‘å½¢ç»“æ„æ¸²æŸ“å®Œæˆ');

                renderGroupTree(hierarchy);
                console.log('âœ… åˆ†ç»„æ ‘å½¢ç»“æ„æ¸²æŸ“å®Œæˆ');

                updateStats(elements, hierarchy);
                console.log('âœ… ç»Ÿè®¡ä¿¡æ¯æ›´æ–°å®Œæˆ');

            } catch (error) {
                console.error('âŒ æ¸²æŸ“é”™è¯¯:', error);
            }
        }

        // äº‹ä»¶ç›‘å¬å™¨
        function initEventListeners() {
            // æµ‹è¯•ç”¨ä¾‹æŒ‰é’®
            document.querySelectorAll('.test-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.test-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentCase = btn.dataset.case;
                    runGrouping();
                });
            });

            // æ ‘å½¢æ§åˆ¶æŒ‰é’®
            document.getElementById('expand-all-btn').addEventListener('click', expandAllNodes);
            document.getElementById('collapse-all-btn').addEventListener('click', collapseAllNodes);
            document.getElementById('refresh-btn').addEventListener('click', runGrouping);
        }

        // åˆå§‹åŒ–
        function init() {
            console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–...');

            // ğŸ¨ è½¬æ¢Figmaæ•°æ®
            console.log('ğŸ¨ è½¬æ¢Figmaæ•°æ®...');
            testCases.figma_cs_enterprise = convertFigmaToElements(figmaRawData);
            console.log('âœ… Figmaæ•°æ®è½¬æ¢å®Œæˆï¼Œå…ƒç´ æ•°é‡:', testCases.figma_cs_enterprise.length);

            console.log('å½“å‰æµ‹è¯•ç”¨ä¾‹:', currentCase);
            console.log('æµ‹è¯•æ•°æ®:', testCases[currentCase]);

            // å…ˆæµ‹è¯•åŸºæœ¬çš„DOMæ“ä½œ
            const originalCanvas = document.getElementById('original-canvas');
            const groupedCanvas = document.getElementById('grouped-canvas');

            if (!originalCanvas || !groupedCanvas) {
                console.error('âŒ æ‰¾ä¸åˆ°ç”»å¸ƒå…ƒç´ ');
                return;
            }

            console.log('âœ… ç”»å¸ƒå…ƒç´ æ‰¾åˆ°');

            try {
                initEventListeners();
                console.log('âœ… äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–å®Œæˆ');

                // å»¶è¿Ÿæ‰§è¡Œåˆ†ç»„ç®—æ³•ï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
                setTimeout(() => {
                    runGrouping();
                    console.log('âœ… åˆ†ç»„ç®—æ³•æ‰§è¡Œå®Œæˆ');
                }, 100);

                console.log('ğŸŒ å®Œæ•´å±‚æ¬¡åŒ–åˆ†ç»„ç®—æ³•å·²åŠ è½½');
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–é”™è¯¯:', error);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
            }
        }

        // åˆ†ç»„æ­£ç¡®æ€§æ ¡éªŒå‡½æ•°
        function validateGrouping(elements, hierarchy) {
            console.log('\nğŸ” å¼€å§‹æ ¡éªŒåˆ†ç»„æ­£ç¡®æ€§...');

            const issues = [];
            const warnings = [];

            // 1. æ£€æŸ¥æ‰€æœ‰å…ƒç´ æ˜¯å¦éƒ½è¢«åŒ…å«
            const allElementsInHierarchy = getAllElementsFromHierarchy(hierarchy);
            const originalElementIds = new Set(elements.map(e => e.id));
            const hierarchyElementIds = new Set(allElementsInHierarchy.map(e => e.id));

            for (const id of originalElementIds) {
                if (!hierarchyElementIds.has(id)) {
                    issues.push(`âŒ å…ƒç´  ${id} åœ¨åˆ†ç»„ä¸­ä¸¢å¤±`);
                }
            }

            // 2. æ£€æŸ¥ç©ºé—´åŒ…å«å…³ç³»æ˜¯å¦æ­£ç¡®
            function validateSpatialRelations(group) {
                if (group.children.length === 0) return;

                for (const child of group.children) {
                    // æ£€æŸ¥å­å…ƒç´ æ˜¯å¦çœŸçš„åœ¨çˆ¶å…ƒç´ å†…éƒ¨
                    if (child.elements && child.elements.length > 0) {
                        const childBounds = child.bounds;
                        const parentBounds = group.bounds;

                        if (childBounds.x < parentBounds.x ||
                            childBounds.y < parentBounds.y ||
                            childBounds.x + childBounds.width > parentBounds.x + parentBounds.width ||
                            childBounds.y + childBounds.height > parentBounds.y + parentBounds.height) {
                            warnings.push(`âš ï¸ å­åˆ†ç»„ ${child.name} è¶…å‡ºçˆ¶åˆ†ç»„ ${group.name} è¾¹ç•Œ`);
                        }
                    }

                    // é€’å½’æ£€æŸ¥å­åˆ†ç»„
                    validateSpatialRelations(child);
                }
            }

            validateSpatialRelations(hierarchy);

            // 3. æ£€æŸ¥åˆ†ç»„çš„åˆç†æ€§
            function validateGroupLogic(group) {
                if (group.children.length === 0) return;

                // æ£€æŸ¥æ˜¯å¦æœ‰å•å­èŠ‚ç‚¹åˆ†ç»„ï¼ˆåº”è¯¥å·²ç»è¢«ä¼˜åŒ–æ‰äº†ï¼‰
                if (group.children.length === 1) {
                    warnings.push(`âš ï¸ åˆ†ç»„ ${group.name} åªæœ‰ä¸€ä¸ªå­åˆ†ç»„ï¼Œå¯èƒ½éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–`);
                }

                // æ£€æŸ¥åˆ†ç»„æ–¹å‘æ˜¯å¦åˆç†
                if (group.children.length > 1) {
                    const direction = group.direction;
                    const childPositions = group.children.map(child => ({
                        x: child.bounds.x,
                        y: child.bounds.y,
                        width: child.bounds.width,
                        height: child.bounds.height
                    }));

                    if (direction === 'HORIZONTAL') {
                        // æ°´å¹³åˆ†ç»„ï¼šæ£€æŸ¥æ˜¯å¦çœŸçš„æ˜¯æ°´å¹³æ’åˆ—
                        const avgY = childPositions.reduce((sum, pos) => sum + pos.y, 0) / childPositions.length;
                        const yVariance = childPositions.reduce((sum, pos) => sum + Math.pow(pos.y - avgY, 2), 0) / childPositions.length;

                        if (yVariance > 1000) { // é˜ˆå€¼å¯è°ƒæ•´
                            warnings.push(`âš ï¸ åˆ†ç»„ ${group.name} æ ‡è®°ä¸ºæ°´å¹³å¸ƒå±€ï¼Œä½†å­å…ƒç´ å‚ç›´ä½ç½®å·®å¼‚è¾ƒå¤§`);
                        }
                    } else if (direction === 'VERTICAL') {
                        // å‚ç›´åˆ†ç»„ï¼šæ£€æŸ¥æ˜¯å¦çœŸçš„æ˜¯å‚ç›´æ’åˆ—
                        const avgX = childPositions.reduce((sum, pos) => sum + pos.x, 0) / childPositions.length;
                        const xVariance = childPositions.reduce((sum, pos) => sum + Math.pow(pos.x - avgX, 2), 0) / childPositions.length;

                        if (xVariance > 1000) { // é˜ˆå€¼å¯è°ƒæ•´
                            warnings.push(`âš ï¸ åˆ†ç»„ ${group.name} æ ‡è®°ä¸ºå‚ç›´å¸ƒå±€ï¼Œä½†å­å…ƒç´ æ°´å¹³ä½ç½®å·®å¼‚è¾ƒå¤§`);
                        }
                    }
                }

                // é€’å½’æ£€æŸ¥å­åˆ†ç»„
                group.children.forEach(validateGroupLogic);
            }

            validateGroupLogic(hierarchy);

            // 4. è¾“å‡ºæ ¡éªŒç»“æœ
            console.log('\nğŸ“Š åˆ†ç»„æ ¡éªŒç»“æœ:');
            console.log('================');

            if (issues.length === 0 && warnings.length === 0) {
                console.log('âœ… åˆ†ç»„å®Œå…¨æ­£ç¡®ï¼æ²¡æœ‰å‘ç°é—®é¢˜ã€‚');
            } else {
                if (issues.length > 0) {
                    console.log('âŒ å‘ç°ä¸¥é‡é—®é¢˜:');
                    issues.forEach(issue => console.log('  ' + issue));
                }

                if (warnings.length > 0) {
                    console.log('âš ï¸ å‘ç°æ½œåœ¨é—®é¢˜:');
                    warnings.forEach(warning => console.log('  ' + warning));
                }
            }

            // 5. è¾“å‡ºåˆ†ç»„ç»Ÿè®¡
            const stats = {
                totalElements: elements.length,
                totalGroups: countTotalGroups(hierarchy),
                maxDepth: getMaxDepth(hierarchy),
                avgGroupSize: calculateAverageGroupSize(hierarchy)
            };

            console.log('\nğŸ“ˆ åˆ†ç»„ç»Ÿè®¡:');
            console.log(`  æ€»å…ƒç´ æ•°: ${stats.totalElements}`);
            console.log(`  æ€»åˆ†ç»„æ•°: ${stats.totalGroups}`);
            console.log(`  æœ€å¤§æ·±åº¦: ${stats.maxDepth}`);
            console.log(`  å¹³å‡åˆ†ç»„å¤§å°: ${stats.avgGroupSize.toFixed(1)}`);

            return {
                isValid: issues.length === 0,
                issues,
                warnings,
                stats
            };
        }

        // ä»å±‚æ¬¡ç»“æ„ä¸­è·å–æ‰€æœ‰å…ƒç´ 
        function getAllElementsFromHierarchy(group) {
            let allElements = [...group.elements];
            for (const child of group.children) {
                allElements = allElements.concat(getAllElementsFromHierarchy(child));
            }
            return allElements;
        }

        // ğŸ¯ æ ¡éªŒå½“å‰ç”¨ä¾‹çš„åˆ†ç»„é€»è¾‘
        function testFunction() {
            console.log(`\nğŸ” ===== è¯¦ç»†æ ¡éªŒç”¨ä¾‹: ${currentCase} =====`);
            validateSingleCaseDetailed(currentCase);
        }

        // ğŸ¯ è¯¦ç»†æ ¡éªŒå•ä¸ªç”¨ä¾‹
        function validateSingleCaseDetailed(caseId) {
            const elements = testCases[caseId];
            if (!elements || elements.length === 0) {
                console.error(`âŒ ${caseId}: æ²¡æœ‰æµ‹è¯•æ•°æ®`);
                return false;
            }

            console.log(`\nğŸ“‹ è¯¦ç»†åˆ†æç”¨ä¾‹: ${caseId}`);
            console.log(`å…ƒç´ åˆ—è¡¨: ${elements.map(e => `${e.name}(${e.x},${e.y},${e.width}Ã—${e.height})`).join(', ')}`);

            try {
                // æ‰§è¡Œåˆ†ç»„ç®—æ³•å¹¶è·å–è¯¦ç»†è¿‡ç¨‹
                const hierarchy = performCompleteHierarchicalGrouping(elements);
                const actualGroups = extractGroupsFromHierarchy(hierarchy);
                const expectedGroups = getExpectedGroups(caseId);

                console.log(`\nğŸ“Š åˆ†ç»„å¯¹æ¯”:`);
                console.log(`é¢„æœŸåˆ†ç»„ (${expectedGroups.length} ç»„):`);
                expectedGroups.forEach((group, index) => {
                    console.log(`  ${index + 1}. [${group.join(', ')}]`);
                });

                console.log(`å®é™…åˆ†ç»„ (${actualGroups.length} ç»„):`);
                actualGroups.forEach((group, index) => {
                    console.log(`  ${index + 1}. [${group.join(', ')}]`);
                });

                return compareGroupingResults(caseId, actualGroups, expectedGroups);

            } catch (error) {
                console.error(`âŒ ${caseId}: åˆ†ç»„ç®—æ³•æ‰§è¡Œé”™è¯¯:`, error);
                return false;
            }
        }

        // å…¨å±€é”™è¯¯ä¿¡æ¯æ”¶é›†
        let globalErrorMessages = [];

        // ğŸ¯ æ ¡éªŒæ‰€æœ‰ç”¨ä¾‹çš„åˆ†ç»„é€»è¾‘
        function validateAllCases() {
            console.log(`\nğŸ” ===== æ ¡éªŒæ‰€æœ‰åˆ†ç»„é€»è¾‘ =====`);

            // æ¸…ç©ºä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
            globalErrorMessages = [];

            const cases = ['simple_card', 'basic_layout', 'form_example', 'navigation_bar', 'dashboard_simple', 'figma_cs_enterprise'];
            let passedCount = 0;

            cases.forEach(caseId => {
                const passed = validateSingleCase(caseId);
                if (passed) passedCount++;
            });

            const summary = `ğŸ“Š æ€»ä½“æ ¡éªŒç»“æœ: ${passedCount}/${cases.length} é€šè¿‡`;
            console.log(`\n${summary}`);
            globalErrorMessages.push(summary);

            if (passedCount === cases.length) {
                const successMsg = 'ğŸ‰ æ‰€æœ‰ç”¨ä¾‹æ ¡éªŒé€šè¿‡ï¼';
                console.log(successMsg);
                globalErrorMessages.push(successMsg);
            } else {
                const warningMsg = 'âš ï¸ éƒ¨åˆ†ç”¨ä¾‹éœ€è¦æ”¹è¿›';
                console.log(warningMsg);
                globalErrorMessages.push(warningMsg);
            }

            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯åˆ°é¡µé¢
            displayErrorMessages();
        }

        // ğŸ¯ æ ¡éªŒå•ä¸ªç”¨ä¾‹
        function validateSingleCase(caseId) {
            const elements = testCases[caseId];
            if (!elements || elements.length === 0) {
                const errorMsg = `âŒ ${caseId}: æ²¡æœ‰æµ‹è¯•æ•°æ®`;
                console.error(errorMsg);
                globalErrorMessages.push(errorMsg);
                return false;
            }

            const caseHeader = `\nğŸ“‹ æ ¡éªŒç”¨ä¾‹: ${caseId}`;
            console.log(caseHeader);
            globalErrorMessages.push(caseHeader);

            const elementList = `å…ƒç´ åˆ—è¡¨: ${elements.map(e => e.name).join(', ')}`;
            console.log(elementList);
            globalErrorMessages.push(elementList);

            try {
                const hierarchy = performCompleteHierarchicalGrouping(elements);
                const actualGroups = extractGroupsFromHierarchy(hierarchy);
                const expectedGroups = getExpectedGroups(caseId);

                return compareGroupingResults(caseId, actualGroups, expectedGroups);

            } catch (error) {
                const errorMsg = `âŒ ${caseId}: åˆ†ç»„ç®—æ³•æ‰§è¡Œé”™è¯¯: ${error.message}`;
                console.error(errorMsg);
                globalErrorMessages.push(errorMsg);
                return false;
            }
        }

        // ğŸ¯ è·å–é¢„æœŸçš„åˆ†ç»„ç»“æœ
        function getExpectedGroups(caseId) {
            const expected = {
                'simple_card': [
                    ['ç”¨æˆ·ä¿¡æ¯'],
                    ['å¤´åƒ', 'å¼ ä¸‰', 'zhang@email.com'],
                    ['ç¼–è¾‘æŒ‰é’®']
                ],
                'basic_layout': [
                    ['Logo', 'é¦–é¡µ', 'å…³äº'],
                    ['æ¬¢è¿ä½¿ç”¨', 'è¿™æ˜¯ä¸»è¦å†…å®¹åŒºåŸŸ...'],
                    ['ç›¸å…³é“¾æ¥', 'å¸®åŠ©æ–‡æ¡£', 'è”ç³»æˆ‘ä»¬'],
                    ['å¼€å§‹ä½¿ç”¨']
                ],
                'form_example': [
                    ['åŸºæœ¬ä¿¡æ¯'],
                    ['å§“å:', 'å§“åè¾“å…¥æ¡†', 'é‚®ç®±:', 'é‚®ç®±è¾“å…¥æ¡†'],
                    ['å¯†ç è®¾ç½®'],
                    ['å¯†ç :', 'å¯†ç è¾“å…¥æ¡†', 'ç¡®è®¤å¯†ç :', 'ç¡®è®¤å¯†ç è¾“å…¥æ¡†'],
                    ['æ³¨å†Œ', 'å–æ¶ˆ']
                ],
                'navigation_bar': [
                    ['Logo', 'æˆ‘çš„ç½‘ç«™'],
                    ['é¦–é¡µ', 'äº§å“', 'æœåŠ¡', 'å…³äº'],
                    ['æœç´¢æ¡†', 'ç™»å½•', 'æ³¨å†Œ']
                ],
                'dashboard_simple': [
                    ['æ•°æ®ä»ªè¡¨æ¿', 'åˆ·æ–°'],
                    ['æ€»ç”¨æˆ·', '1,234', '+12%'],
                    ['é”€å”®é¢', 'Â¥56,789', '+8%'],
                    ['è®¢å•æ•°', '456', '+15%'],
                    ['æœ€è¿‘æ´»åŠ¨', 'æ–°ç”¨æˆ·æ³¨å†Œ', 'è®¢å•å®Œæˆ', 'æ”¯ä»˜æˆåŠŸ'],
                    ['é”€å”®è¶‹åŠ¿', 'å›¾è¡¨å†…å®¹']
                ],
                'figma_cs_enterprise': [
                    ['cs_ic_common_invite_user_é‚€è¯·æˆå‘˜', 'é‚€è¯·æˆå‘˜'],
                    ['cs_ic_common_import_doc_å¯¼å…¥æ–‡æ¡£', 'æ‰¹å¯¼å…¥æˆå‘˜'],
                    ['cs_ic_common_extract-æå–é¡µé¢', 'å¯¼å‡ºæˆå‘˜åˆ—è¡¨'],
                    ['cs_ic_common_subscribe_è®¢é˜…', 'æ‰¹é‡æé†’']
                ]
            };

            return expected[caseId] || [];
        }

        // ğŸ¯ ä»å±‚æ¬¡ç»“æ„ä¸­æå–åˆ†ç»„ï¼ˆä¿®å¤ç‰ˆæœ¬ï¼‰
        function extractGroupsFromHierarchy(hierarchy) {
            const groups = [];

            function extractGroups(node) {
                console.log(`ğŸ” æå–åˆ†ç»„ - èŠ‚ç‚¹: ${node.name}, å…ƒç´ æ•°: ${node.elements?.length || 0}, å­èŠ‚ç‚¹æ•°: ${node.children?.length || 0}`);

                // å¦‚æœæœ‰å­èŠ‚ç‚¹ï¼Œä¼˜å…ˆå¤„ç†å­èŠ‚ç‚¹
                if (node.children && node.children.length > 0) {
                    console.log(`  ğŸ“‚ å¤„ç† ${node.children.length} ä¸ªå­èŠ‚ç‚¹`);
                    node.children.forEach(child => extractGroups(child));
                } else if (node.elements && node.elements.length > 0) {
                    // åªæœ‰åœ¨æ²¡æœ‰å­èŠ‚ç‚¹æ—¶ï¼Œæ‰å°†å…ƒç´ ä½œä¸ºå¶å­åˆ†ç»„
                    const elementNames = node.elements.map(e => e.name);
                    console.log(`  ğŸ“¦ å¶å­åˆ†ç»„: [${elementNames.join(', ')}]`);
                    groups.push(elementNames);
                }
            }

            extractGroups(hierarchy);
            console.log(`ğŸ¯ æœ€ç»ˆæå–åˆ° ${groups.length} ä¸ªåˆ†ç»„: ${groups.map(g => `[${g.join(', ')}]`).join(', ')}`);
            return groups;
        }

        // ğŸ¯ æ¯”è¾ƒåˆ†ç»„ç»“æœ
        function compareGroupingResults(caseId, actualGroups, expectedGroups) {
            const comparisonHeader = `\nğŸ” ${caseId} - åˆ†ç»„å¯¹æ¯”:`;
            console.log(comparisonHeader);
            globalErrorMessages.push(comparisonHeader);

            const expectedInfo = `é¢„æœŸåˆ†ç»„ (${expectedGroups.length} ç»„): ${JSON.stringify(expectedGroups)}`;
            const actualInfo = `å®é™…åˆ†ç»„ (${actualGroups.length} ç»„): ${JSON.stringify(actualGroups)}`;
            console.log(expectedInfo);
            console.log(actualInfo);
            globalErrorMessages.push(expectedInfo);
            globalErrorMessages.push(actualInfo);

            let passed = true;
            const issues = [];

            // æ£€æŸ¥åˆ†ç»„æ•°é‡
            if (actualGroups.length !== expectedGroups.length) {
                issues.push(`åˆ†ç»„æ•°é‡ä¸åŒ¹é…: é¢„æœŸ ${expectedGroups.length}, å®é™… ${actualGroups.length}`);
                passed = false;
            }

            // æ£€æŸ¥æ¯ä¸ªåˆ†ç»„çš„å†…å®¹
            expectedGroups.forEach((expectedGroup, index) => {
                const actualGroup = actualGroups[index];

                if (!actualGroup) {
                    issues.push(`ç¼ºå°‘ç¬¬ ${index + 1} ä¸ªåˆ†ç»„: ${expectedGroup.join(', ')}`);
                    passed = false;
                    return;
                }

                // æ£€æŸ¥åˆ†ç»„å†…å®¹æ˜¯å¦åŒ¹é…ï¼ˆå¿½ç•¥é¡ºåºï¼‰
                const expectedSet = new Set(expectedGroup);
                const actualSet = new Set(actualGroup);

                if (expectedSet.size !== actualSet.size) {
                    issues.push(`ç¬¬ ${index + 1} ç»„å…ƒç´ æ•°é‡ä¸åŒ¹é…: é¢„æœŸ ${expectedGroup.join(', ')}, å®é™… ${actualGroup.join(', ')}`);
                    passed = false;
                } else {
                    for (const item of expectedSet) {
                        if (!actualSet.has(item)) {
                            issues.push(`ç¬¬ ${index + 1} ç»„ç¼ºå°‘å…ƒç´ : ${item}`);
                            passed = false;
                        }
                    }
                    for (const item of actualSet) {
                        if (!expectedSet.has(item)) {
                            issues.push(`ç¬¬ ${index + 1} ç»„å¤šä½™å…ƒç´ : ${item}`);
                            passed = false;
                        }
                    }
                }
            });

            // è¾“å‡ºç»“æœ
            if (passed) {
                const successMsg = `âœ… ${caseId}: åˆ†ç»„é€»è¾‘æ­£ç¡®`;
                console.log(successMsg);
                globalErrorMessages.push(successMsg);
            } else {
                const errorMsg = `âŒ ${caseId}: åˆ†ç»„é€»è¾‘æœ‰é—®é¢˜`;
                console.log(errorMsg);
                globalErrorMessages.push(errorMsg);
                issues.forEach(issue => {
                    const issueMsg = `   - ${issue}`;
                    console.log(issueMsg);
                    globalErrorMessages.push(issueMsg);
                });
            }

            return passed;
        }

        // ğŸ¯ æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯åˆ°é¡µé¢
        function displayErrorMessages() {
            const errorOutput = document.getElementById('error-output');
            if (globalErrorMessages.length > 0) {
                errorOutput.innerHTML = globalErrorMessages.join('\n');
                errorOutput.style.display = 'block';
            } else {
                errorOutput.style.display = 'none';
            }
        }

        // ğŸ¯ å¤åˆ¶é”™è¯¯ä¿¡æ¯åˆ°å‰ªè´´æ¿
        function copyErrorsToClipboard() {
            if (globalErrorMessages.length === 0) {
                alert('æ²¡æœ‰é”™è¯¯ä¿¡æ¯å¯å¤åˆ¶ï¼Œè¯·å…ˆè¿è¡Œæ ¡éªŒ');
                return;
            }

            const errorText = globalErrorMessages.join('\n');

            // ä½¿ç”¨ç°ä»£çš„ Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(errorText).then(() => {
                    alert('é”™è¯¯ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    fallbackCopyToClipboard(errorText);
                });
            } else {
                // é™çº§æ–¹æ¡ˆ
                fallbackCopyToClipboard(errorText);
            }
        }

        // ğŸ¯ é™çº§å¤åˆ¶æ–¹æ¡ˆ
        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                alert('é”™è¯¯ä¿¡æ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é¡µé¢ä¸Šæ˜¾ç¤ºçš„é”™è¯¯ä¿¡æ¯');
            }

            document.body.removeChild(textArea);
        }

        // ğŸ¯ æ˜¾ç¤ºè‡ªåŠ¨æµ‹è¯•ç»“æœ
        function displayAutoTestResults() {
            const autoTestDiv = document.getElementById('auto-test-result');
            const testContent = document.getElementById('test-content');

            if (globalErrorMessages.length > 0) {
                // æå–å…³é”®ä¿¡æ¯
                const keyLines = globalErrorMessages.filter(line =>
                    line.includes('æ ¡éªŒç”¨ä¾‹:') ||
                    line.includes('é¢„æœŸåˆ†ç»„') ||
                    line.includes('å®é™…åˆ†ç»„') ||
                    line.includes('åˆ†ç»„é€»è¾‘æœ‰é—®é¢˜') ||
                    line.includes('åˆ†ç»„é€»è¾‘æ­£ç¡®')
                );

                // æ ¼å¼åŒ–æ˜¾ç¤º
                let htmlContent = '';
                let currentCase = '';

                keyLines.forEach(line => {
                    if (line.includes('æ ¡éªŒç”¨ä¾‹:')) {
                        currentCase = line.replace('ğŸ“‹ æ ¡éªŒç”¨ä¾‹: ', '');
                        htmlContent += `<div style="margin: 10px 0; font-weight: bold; color: #0066cc;">${line}</div>`;
                    } else if (line.includes('é¢„æœŸåˆ†ç»„')) {
                        htmlContent += `<div style="margin: 5px 0; color: #28a745;">${line}</div>`;
                    } else if (line.includes('å®é™…åˆ†ç»„')) {
                        htmlContent += `<div style="margin: 5px 0; color: #dc3545;">${line}</div>`;
                    } else if (line.includes('åˆ†ç»„é€»è¾‘')) {
                        const isCorrect = line.includes('æ­£ç¡®');
                        const color = isCorrect ? '#28a745' : '#dc3545';
                        const icon = isCorrect ? 'âœ…' : 'âŒ';
                        htmlContent += `<div style="margin: 5px 0; color: ${color}; font-weight: bold;">${icon} ${line}</div>`;
                    }
                });

                testContent.innerHTML = htmlContent;
                autoTestDiv.style.display = 'block';

                // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                autoTestDiv.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // ğŸ¯ è‡ªåŠ¨æµ‹è¯•å’Œåˆ†æå‡½æ•°
        function runAutoTestAndAnalyze() {
            console.log('\nğŸ¤– å¼€å§‹è‡ªåŠ¨æµ‹è¯•å’Œåˆ†æ...');

            // è¿è¡Œæ‰€æœ‰æµ‹è¯•
            validateAllCases();

            // åˆ†æç»“æœ
            const testResults = analyzeTestResults();

            // è¾“å‡ºåˆ†æç»“æœ
            console.log('\nğŸ“Š === æµ‹è¯•ç»“æœåˆ†æ ===');
            console.log(`æ€»é€šè¿‡ç‡: ${testResults.passRate}%`);
            console.log(`å¤±è´¥ç”¨ä¾‹: ${testResults.failedCases.join(', ')}`);

            // è¾“å‡ºè¯¦ç»†é”™è¯¯åˆ†æ
            testResults.failedCases.forEach(caseId => {
                const caseAnalysis = analyzeCaseErrors(caseId);
                console.log(`\nğŸ” ${caseId} é”™è¯¯åˆ†æ:`);
                console.log(`  é—®é¢˜ç±»å‹: ${caseAnalysis.problemType}`);
                console.log(`  å»ºè®®ä¿®å¤: ${caseAnalysis.suggestion}`);
            });

            return testResults;
        }

        // ğŸ¯ åˆ†ææµ‹è¯•ç»“æœ
        function analyzeTestResults() {
            const cases = ['simple_card', 'basic_layout', 'form_example', 'navigation_bar', 'dashboard_simple', 'figma_cs_enterprise'];
            const failedCases = [];
            let passedCount = 0;

            // ä»é”™è¯¯ä¿¡æ¯ä¸­æå–å¤±è´¥çš„ç”¨ä¾‹
            globalErrorMessages.forEach(line => {
                if (line.includes('åˆ†ç»„é€»è¾‘æœ‰é—®é¢˜')) {
                    const caseId = line.match(/(\w+):/)?.[1];
                    if (caseId && !failedCases.includes(caseId)) {
                        failedCases.push(caseId);
                    }
                } else if (line.includes('åˆ†ç»„é€»è¾‘æ­£ç¡®')) {
                    passedCount++;
                }
            });

            return {
                totalCases: cases.length,
                passedCount: passedCount,
                failedCases: failedCases,
                passRate: Math.round((passedCount / cases.length) * 100)
            };
        }

        // ğŸ¯ åˆ†æå•ä¸ªç”¨ä¾‹çš„é”™è¯¯
        function analyzeCaseErrors(caseId) {
            const caseMessages = globalErrorMessages.filter(line =>
                line.includes(caseId) ||
                (globalErrorMessages.indexOf(line) > globalErrorMessages.findIndex(l => l.includes(`æ ¡éªŒç”¨ä¾‹: ${caseId}`)) &&
                 globalErrorMessages.indexOf(line) < globalErrorMessages.findIndex(l => l.includes('æ ¡éªŒç”¨ä¾‹:') && l.indexOf(caseId) === -1))
            );

            let problemType = 'æœªçŸ¥é—®é¢˜';
            let suggestion = 'éœ€è¦è¿›ä¸€æ­¥åˆ†æ';

            // åˆ†æé—®é¢˜ç±»å‹
            if (caseMessages.some(line => line.includes('åˆ†ç»„æ•°é‡ä¸åŒ¹é…'))) {
                const actualCount = caseMessages.find(line => line.includes('å®é™…åˆ†ç»„'))?.match(/(\d+) ç»„/)?.[1];
                const expectedCount = caseMessages.find(line => line.includes('é¢„æœŸåˆ†ç»„'))?.match(/(\d+) ç»„/)?.[1];

                if (actualCount && expectedCount) {
                    if (parseInt(actualCount) > parseInt(expectedCount)) {
                        problemType = 'åˆ†ç»„è¿‡ç»†';
                        suggestion = 'éœ€è¦æ”¾å®½åˆ†ç»„æ¡ä»¶ï¼Œè®©æ›´å¤šå…ƒç´ åˆå¹¶åˆ°ä¸€ç»„';
                    } else {
                        problemType = 'åˆ†ç»„è¿‡ç²—';
                        suggestion = 'éœ€è¦ä¸¥æ ¼åˆ†ç»„æ¡ä»¶ï¼Œé¿å…ä¸ç›¸å…³å…ƒç´ è¢«åˆ†åˆ°ä¸€ç»„';
                    }
                }
            }

            return { problemType, suggestion };
        }

        // ğŸ¯ å°è¯•è‡ªåŠ¨ä¿®å¤
        function attemptAutoFix(testResults) {
            console.log(`\nğŸ”§ åˆ†æ ${testResults.failedCases.length} ä¸ªå¤±è´¥ç”¨ä¾‹...`);

            // ç»Ÿè®¡é—®é¢˜ç±»å‹
            const problemStats = {
                tooFine: 0,    // åˆ†ç»„è¿‡ç»†
                tooCoarse: 0,  // åˆ†ç»„è¿‡ç²—
                mixed: 0       // æ··åˆé—®é¢˜
            };

            testResults.failedCases.forEach(caseId => {
                const analysis = analyzeCaseErrors(caseId);
                if (analysis.problemType === 'åˆ†ç»„è¿‡ç»†') {
                    problemStats.tooFine++;
                } else if (analysis.problemType === 'åˆ†ç»„è¿‡ç²—') {
                    problemStats.tooCoarse++;
                } else {
                    problemStats.mixed++;
                }
            });

            console.log('é—®é¢˜ç»Ÿè®¡:', problemStats);

            // æ ¹æ®ä¸»è¦é—®é¢˜ç±»å‹è°ƒæ•´ç®—æ³•
            if (problemStats.tooFine > problemStats.tooCoarse) {
                console.log('ğŸ”§ ä¸»è¦é—®é¢˜ï¼šåˆ†ç»„è¿‡ç»†ï¼Œéœ€è¦æ”¾å®½æ¡ä»¶');
                adjustGroupingForCoarser();
            } else if (problemStats.tooCoarse > problemStats.tooFine) {
                console.log('ğŸ”§ ä¸»è¦é—®é¢˜ï¼šåˆ†ç»„è¿‡ç²—ï¼Œéœ€è¦ä¸¥æ ¼æ¡ä»¶');
                adjustGroupingForFiner();
            } else {
                console.log('ğŸ”§ é—®é¢˜ç±»å‹æ··åˆï¼Œéœ€è¦æ›´ç²¾ç»†çš„è°ƒæ•´');
                adjustGroupingMixed();
            }

            // é‡æ–°æµ‹è¯•
            setTimeout(() => {
                console.log('\nğŸ”„ é‡æ–°æµ‹è¯•ä¿®å¤æ•ˆæœ...');
                runAutoTestAndAnalyze();
            }, 1000);
        }

        // ğŸ¯ è°ƒæ•´ç®—æ³•ä½¿åˆ†ç»„æ›´ç²—ç³™ï¼ˆåˆå¹¶æ›´å¤šå…ƒç´ ï¼‰
        function adjustGroupingForCoarser() {
            console.log('è°ƒæ•´ç­–ç•¥ï¼šæ”¾å®½æˆªæ–­æ£€æµ‹æ¡ä»¶');
            // è¿™é‡Œå¯ä»¥åŠ¨æ€è°ƒæ•´ç®—æ³•å‚æ•°
            window.GROUPING_MODE = 'COARSER';
        }

        // ğŸ¯ è°ƒæ•´ç®—æ³•ä½¿åˆ†ç»„æ›´ç²¾ç»†ï¼ˆåˆ†ç¦»æ›´å¤šå…ƒç´ ï¼‰
        function adjustGroupingForFiner() {
            console.log('è°ƒæ•´ç­–ç•¥ï¼šä¸¥æ ¼æˆªæ–­æ£€æµ‹æ¡ä»¶');
            // è¿™é‡Œå¯ä»¥åŠ¨æ€è°ƒæ•´ç®—æ³•å‚æ•°
            window.GROUPING_MODE = 'FINER';
        }

        // ğŸ¯ æ··åˆè°ƒæ•´ç­–ç•¥
        function adjustGroupingMixed() {
            console.log('è°ƒæ•´ç­–ç•¥ï¼šä½¿ç”¨æ··åˆæ¨¡å¼');
            window.GROUPING_MODE = 'MIXED';
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
