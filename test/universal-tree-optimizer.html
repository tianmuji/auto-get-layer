<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ³ é€šç”¨æ ‘å½¢ç»“æ„ä¼˜åŒ–å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .content {
            padding: 30px;
        }

        .input-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 2px solid #e2e8f0;
        }

        .input-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1f2937;
        }

        .input-area {
            width: 100%;
            height: 200px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            resize: vertical;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin: 15px 0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .result-panel {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e2e8f0;
        }

        .panel-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tree-display {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #d1d5db;
            min-height: 300px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            line-height: 1.5;
            overflow-x: auto;
        }

        .tree-node {
            margin: 1px 0;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .tree-node.invalid {
            background: #fef2f2;
            color: #dc2626;
        }

        .tree-node.valid {
            background: #ecfdf5;
            color: #059669;
        }

        .tree-node.root {
            background: #eff6ff;
            color: #1d4ed8;
            font-weight: 600;
        }

        .operations-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            border: 1px solid #e2e8f0;
            margin-top: 20px;
        }

        .operation-step {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #3b82f6;
            position: relative;
        }

        .operation-step.remove {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .operation-step.add {
            border-left-color: #10b981;
            background: #ecfdf5;
        }

        .operation-step.move {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .step-number {
            position: absolute;
            top: -8px;
            left: -8px;
            background: #3b82f6;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: 600;
        }

        .step-number.remove { background: #ef4444; }
        .step-number.add { background: #10b981; }
        .step-number.move { background: #f59e0b; }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #3b82f6;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.85em;
            margin-top: 5px;
        }

        .example-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .example-btn {
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .example-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .canvas-container {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            position: relative;
            height: 250px;
            margin: 10px 0;
            overflow: hidden;
        }

        .element {
            position: absolute;
            border: 2px solid;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 600;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            cursor: pointer;
            z-index: 10;
        }

        .element-container { background-color: #4299e1; border-color: #3182ce; }
        .element-text { background-color: #ed8936; border-color: #dd6b20; }
        .element-button { background-color: #9f7aea; border-color: #805ad5; }
        .element-image { background-color: #48bb78; border-color: #38a169; }
        .element-normal { background-color: #38b2ac; border-color: #319795; }

        .group-boundary {
            position: absolute;
            border: 2px dashed #4299e1;
            background: rgba(66, 153, 225, 0.1);
            border-radius: 6px;
            pointer-events: none;
            z-index: 5;
        }

        .group-boundary.optimized {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ³ é€šç”¨æ ‘å½¢ç»“æ„ä¼˜åŒ–å™¨</h1>
            <p>åŸºäºå‡ ä½•ä½ç½®å…³ç³»ï¼Œä¼˜åŒ–ä»»æ„æ ‘å½¢ç»“æ„ï¼ˆåŒ…æ‹¬æ‰“å¹³ç»“æ„ï¼‰ï¼Œè¾“å‡ºæœ€å°æ“ä½œæ­¥éª¤</p>
        </div>

        <div class="content">
            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="input-section">
                <div class="input-title">ğŸ“ è¾“å…¥æ ‘å½¢ç»“æ„æ•°æ® (JSONæ ¼å¼)</div>
                <div class="example-buttons">
                    <button class="example-btn" data-example="flat">ğŸ“„ æ‰“å¹³ç»“æ„ç¤ºä¾‹</button>
                    <button class="example-btn" data-example="wrong_hierarchy">ğŸ”€ é”™è¯¯å±‚æ¬¡ç¤ºä¾‹</button>
                    <button class="example-btn" data-example="mixed">ğŸŒªï¸ æ··åˆé—®é¢˜ç¤ºä¾‹</button>
                    <button class="example-btn" data-example="complex">ğŸ”¥ å¤æ‚ç»“æ„ç¤ºä¾‹</button>
                </div>
                <textarea id="input-data" class="input-area" placeholder="è¯·è¾“å…¥èŠ‚ç‚¹æ•°æ®ï¼Œæ ¼å¼å¦‚ï¼š
[
  {&quot;id&quot;: &quot;root&quot;, &quot;name&quot;: &quot;æ ¹èŠ‚ç‚¹&quot;, &quot;x&quot;: 0, &quot;y&quot;: 0, &quot;width&quot;: 400, &quot;height&quot;: 300, &quot;type&quot;: &quot;container&quot;, &quot;parent&quot;: null},
  {&quot;id&quot;: &quot;child1&quot;, &quot;name&quot;: &quot;å­èŠ‚ç‚¹1&quot;, &quot;x&quot;: 20, &quot;y&quot;: 20, &quot;width&quot;: 180, &quot;height&quot;: 120, &quot;type&quot;: &quot;text&quot;, &quot;parent&quot;: &quot;root&quot;},
  ...
]"></textarea>
                <div class="button-group">
                    <button class="btn btn-primary" id="parse-btn">ğŸ” è§£æç»“æ„</button>
                    <button class="btn btn-success" id="optimize-btn">ğŸš€ å¼€å§‹ä¼˜åŒ–</button>
                    <button class="btn btn-secondary" id="clear-btn">ğŸ—‘ï¸ æ¸…ç©º</button>
                </div>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-value" id="total-nodes">0</div>
                    <div class="stat-label">æ€»èŠ‚ç‚¹æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="invalid-relations">0</div>
                    <div class="stat-label">æ— æ•ˆå…³ç³»</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="operation-count">0</div>
                    <div class="stat-label">æ“ä½œæ­¥éª¤</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="tree-depth">0</div>
                    <div class="stat-label">æ ‘æ·±åº¦</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="optimization-score">0%</div>
                    <div class="stat-label">ä¼˜åŒ–åº¦</div>
                </div>
            </div>

            <!-- ç»“æœå±•ç¤º -->
            <div class="results-grid">
                <div class="result-panel">
                    <div class="panel-title">ğŸ”´ åŸå§‹ç»“æ„</div>
                    <div class="canvas-container" id="original-canvas"></div>
                    <div class="tree-display" id="original-tree"></div>
                </div>
                
                <div class="result-panel">
                    <div class="panel-title">âœ… ä¼˜åŒ–ç»“æ„</div>
                    <div class="canvas-container" id="optimized-canvas"></div>
                    <div class="tree-display" id="optimized-tree"></div>
                </div>
                
                <div class="result-panel">
                    <div class="panel-title">ğŸ“Š é—®é¢˜åˆ†æ</div>
                    <div class="tree-display" id="analysis-result"></div>
                </div>
            </div>

            <!-- ç»“æ„å¯¹æ¯” -->
            <div class="operations-section" id="comparison-section" style="display: none;">
                <h3 style="margin-bottom: 20px;">ğŸ”„ ç»“æ„å¯¹æ¯”åˆ†æ</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <h4 style="color: #dc2626; margin-bottom: 15px;">ğŸ”´ åŸå§‹ç»“æ„å±‚æ¬¡</h4>
                        <div id="original-hierarchy" style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 15px; font-family: monospace; font-size: 12px; line-height: 1.5;"></div>
                    </div>
                    <div>
                        <h4 style="color: #059669; margin-bottom: 15px;">âœ… ä¼˜åŒ–åç»“æ„å±‚æ¬¡</h4>
                        <div id="optimized-hierarchy" style="background: #ecfdf5; border: 1px solid #bbf7d0; border-radius: 8px; padding: 15px; font-family: monospace; font-size: 12px; line-height: 1.5;"></div>
                    </div>
                </div>
            </div>

            <!-- æ“ä½œæ­¥éª¤ -->
            <div class="operations-section">
                <h3 style="margin-bottom: 20px;">ğŸ“‹ æœ€å°æ“ä½œæ­¥éª¤</h3>
                <div id="operations-list"></div>
            </div>
        </div>
    </div>

    <script>
        // ç¤ºä¾‹æ•°æ®
        const examples = {
            flat: [
                {"id": "root", "name": "æ ¹å®¹å™¨", "x": 0, "y": 0, "width": 400, "height": 300, "type": "container", "parent": null},
                {"id": "header", "name": "å¤´éƒ¨åŒºåŸŸ", "x": 20, "y": 20, "width": 360, "height": 60, "type": "container", "parent": "root"},
                {"id": "logo", "name": "Logo", "x": 40, "y": 35, "width": 60, "height": 30, "type": "image", "parent": "root"},
                {"id": "title", "name": "æ ‡é¢˜", "x": 120, "y": 35, "width": 200, "height": 30, "type": "text", "parent": "root"},
                {"id": "content", "name": "å†…å®¹åŒºåŸŸ", "x": 20, "y": 100, "width": 360, "height": 180, "type": "container", "parent": "root"},
                {"id": "text1", "name": "æ–‡æœ¬1", "x": 40, "y": 120, "width": 150, "height": 40, "type": "text", "parent": "root"},
                {"id": "text2", "name": "æ–‡æœ¬2", "x": 210, "y": 120, "width": 150, "height": 40, "type": "text", "parent": "root"},
                {"id": "button1", "name": "æŒ‰é’®1", "x": 40, "y": 180, "width": 100, "height": 30, "type": "button", "parent": "root"},
                {"id": "button2", "name": "æŒ‰é’®2", "x": 260, "y": 180, "width": 100, "height": 30, "type": "button", "parent": "root"}
            ],

            wrong_hierarchy: [
                {"id": "root", "name": "æ ¹å®¹å™¨", "x": 0, "y": 0, "width": 350, "height": 250, "type": "container", "parent": null},
                {"id": "outer", "name": "å¤–å±‚å®¹å™¨", "x": 20, "y": 20, "width": 310, "height": 210, "type": "container", "parent": "root"},
                {"id": "middle", "name": "ä¸­å±‚å®¹å™¨", "x": 40, "y": 40, "width": 270, "height": 170, "type": "container", "parent": "root"},
                {"id": "inner", "name": "å†…å±‚å®¹å™¨", "x": 60, "y": 60, "width": 230, "height": 130, "type": "container", "parent": "outer"},
                {"id": "content1", "name": "å†…å®¹1", "x": 80, "y": 80, "width": 80, "height": 60, "type": "text", "parent": "middle"},
                {"id": "content2", "name": "å†…å®¹2", "x": 180, "y": 80, "width": 80, "height": 60, "type": "text", "parent": "inner"}
            ],

            mixed: [
                {"id": "root", "name": "æ ¹å®¹å™¨", "x": 0, "y": 0, "width": 500, "height": 400, "type": "container", "parent": null},
                {"id": "header", "name": "å¤´éƒ¨", "x": 20, "y": 20, "width": 460, "height": 80, "type": "container", "parent": "root"},
                {"id": "main", "name": "ä¸»ä½“", "x": 20, "y": 120, "width": 460, "height": 260, "type": "container", "parent": "root"},
                {"id": "sidebar", "name": "ä¾§è¾¹æ ", "x": 40, "y": 140, "width": 120, "height": 220, "type": "container", "parent": "root"},
                {"id": "content", "name": "å†…å®¹åŒº", "x": 180, "y": 140, "width": 280, "height": 220, "type": "container", "parent": "header"},
                {"id": "logo", "name": "Logo", "x": 40, "y": 40, "width": 60, "height": 40, "type": "image", "parent": "main"},
                {"id": "nav", "name": "å¯¼èˆª", "x": 120, "y": 40, "width": 300, "height": 40, "type": "text", "parent": "sidebar"},
                {"id": "widget1", "name": "ç»„ä»¶1", "x": 50, "y": 160, "width": 100, "height": 80, "type": "normal", "parent": "content"},
                {"id": "widget2", "name": "ç»„ä»¶2", "x": 50, "y": 260, "width": 100, "height": 80, "type": "normal", "parent": "header"},
                {"id": "article", "name": "æ–‡ç« ", "x": 200, "y": 160, "width": 240, "height": 180, "type": "text", "parent": "sidebar"}
            ],

            complex: [
                {"id": "app", "name": "åº”ç”¨æ ¹èŠ‚ç‚¹", "x": 0, "y": 0, "width": 800, "height": 600, "type": "container", "parent": null},
                {"id": "topbar", "name": "é¡¶éƒ¨æ ", "x": 0, "y": 0, "width": 800, "height": 50, "type": "container", "parent": "app"},
                {"id": "workspace", "name": "å·¥ä½œåŒº", "x": 0, "y": 50, "width": 800, "height": 550, "type": "container", "parent": "app"},
                {"id": "menu", "name": "èœå•", "x": 10, "y": 10, "width": 100, "height": 30, "type": "button", "parent": "app"},
                {"id": "search", "name": "æœç´¢æ¡†", "x": 150, "y": 10, "width": 200, "height": 30, "type": "text", "parent": "workspace"},
                {"id": "user", "name": "ç”¨æˆ·ä¿¡æ¯", "x": 650, "y": 10, "width": 140, "height": 30, "type": "text", "parent": "app"},
                {"id": "sidebar", "name": "ä¾§è¾¹æ ", "x": 20, "y": 70, "width": 200, "height": 510, "type": "container", "parent": "app"},
                {"id": "main_content", "name": "ä¸»å†…å®¹", "x": 240, "y": 70, "width": 540, "height": 510, "type": "container", "parent": "topbar"},
                {"id": "nav_item1", "name": "å¯¼èˆªé¡¹1", "x": 30, "y": 90, "width": 180, "height": 40, "type": "button", "parent": "main_content"},
                {"id": "nav_item2", "name": "å¯¼èˆªé¡¹2", "x": 30, "y": 140, "width": 180, "height": 40, "type": "button", "parent": "workspace"},
                {"id": "content_header", "name": "å†…å®¹å¤´éƒ¨", "x": 260, "y": 90, "width": 500, "height": 60, "type": "container", "parent": "sidebar"},
                {"id": "content_body", "name": "å†…å®¹ä¸»ä½“", "x": 260, "y": 170, "width": 500, "height": 390, "type": "container", "parent": "app"},
                {"id": "title", "name": "æ ‡é¢˜", "x": 280, "y": 110, "width": 300, "height": 20, "type": "text", "parent": "content_body"},
                {"id": "subtitle", "name": "å‰¯æ ‡é¢˜", "x": 280, "y": 130, "width": 200, "height": 15, "type": "text", "parent": "app"},
                {"id": "article_text", "name": "æ–‡ç« å†…å®¹", "x": 280, "y": 190, "width": 460, "height": 350, "type": "text", "parent": "content_header"}
            ]
        };

        let currentData = null;
        let originalStructure = null;
        let optimizedStructure = null;
        let operations = [];

        // å‡ ä½•å…³ç³»æ£€æµ‹
        function isElementContained(containerBounds, elementBounds) {
            return containerBounds.minX <= elementBounds.minX &&
                   containerBounds.minY <= elementBounds.minY &&
                   containerBounds.maxX >= elementBounds.maxX &&
                   containerBounds.maxY >= elementBounds.maxY;
        }

        function getElementBounds(element) {
            return {
                minX: element.x,
                minY: element.y,
                maxX: element.x + element.width,
                maxY: element.y + element.height
            };
        }

        function hasPartialOverlap(bounds1, bounds2) {
            const hasOverlap = !(bounds1.maxX <= bounds2.minX ||
                                bounds2.maxX <= bounds1.minX ||
                                bounds1.maxY <= bounds2.minY ||
                                bounds2.maxY <= bounds1.minY);
            const isContained1 = isElementContained(bounds1, bounds2);
            const isContained2 = isElementContained(bounds2, bounds1);
            return hasOverlap && !isContained1 && !isContained2;
        }

        // æ ¸å¿ƒä¼˜åŒ–ç®—æ³•
        function optimizeTreeStructure(nodes) {
            console.log('ğŸš€ å¼€å§‹ä¼˜åŒ–æ ‘å½¢ç»“æ„...');

            // 1. åˆ†æå½“å‰ç»“æ„é—®é¢˜
            const problems = analyzeStructureProblems(nodes);
            console.log('ğŸ“Š å‘ç°é—®é¢˜:', problems);

            // 2. åŸºäºå‡ ä½•å…³ç³»æ„å»ºç†æƒ³ç»“æ„
            const idealStructure = buildIdealStructure(nodes);
            console.log('ğŸ¯ ç†æƒ³ç»“æ„:', idealStructure);

            // 3. è®¡ç®—æœ€å°æ“ä½œæ­¥éª¤
            const operations = calculateMinimalOperations(nodes, idealStructure);
            console.log('ğŸ“‹ æ“ä½œæ­¥éª¤:', operations);

            // 4. åº”ç”¨æ“ä½œç”Ÿæˆä¼˜åŒ–åç»“æ„
            const optimizedNodes = applyOperations(nodes, operations);

            return {
                originalNodes: nodes,
                optimizedNodes: optimizedNodes,
                operations: operations,
                problems: problems,
                stats: calculateOptimizationStats(nodes, optimizedNodes, operations)
            };
        }

        // åˆ†æç»“æ„é—®é¢˜
        function analyzeStructureProblems(nodes) {
            const problems = [];
            const nodeMap = new Map(nodes.map(n => [n.id, n]));

            nodes.forEach(node => {
                if (node.parent === null) return; // è·³è¿‡æ ¹èŠ‚ç‚¹

                const parent = nodeMap.get(node.parent);
                if (!parent) {
                    problems.push({
                        type: 'missing_parent',
                        node: node.id,
                        description: `èŠ‚ç‚¹ ${node.name} çš„çˆ¶èŠ‚ç‚¹ ${node.parent} ä¸å­˜åœ¨`
                    });
                    return;
                }

                // æ£€æŸ¥å‡ ä½•åŒ…å«å…³ç³»
                const parentBounds = getElementBounds(parent);
                const nodeBounds = getElementBounds(node);

                if (!isElementContained(parentBounds, nodeBounds)) {
                    problems.push({
                        type: 'geometric_mismatch',
                        node: node.id,
                        parent: parent.id,
                        description: `èŠ‚ç‚¹ ${node.name} åœ¨å‡ ä½•ä¸Šä¸è¢«çˆ¶èŠ‚ç‚¹ ${parent.name} åŒ…å«`
                    });
                }

                // æ£€æŸ¥é‡å å†²çª
                nodes.forEach(otherNode => {
                    if (otherNode.id === node.id || otherNode.parent !== node.parent) return;

                    const otherBounds = getElementBounds(otherNode);
                    if (hasPartialOverlap(nodeBounds, otherBounds)) {
                        problems.push({
                            type: 'sibling_overlap',
                            node: node.id,
                            conflictWith: otherNode.id,
                            description: `èŠ‚ç‚¹ ${node.name} ä¸åŒçº§èŠ‚ç‚¹ ${otherNode.name} å­˜åœ¨é‡å `
                        });
                    }
                });
            });

            return problems;
        }

        // æ„å»ºç†æƒ³ç»“æ„
        function buildIdealStructure(nodes) {
            console.log('ğŸ” æ„å»ºç†æƒ³ç»“æ„...');

            // 1. æ‰¾å‡ºæ‰€æœ‰å¯èƒ½çš„åŒ…å«å…³ç³»
            const containmentRelations = [];

            for (let i = 0; i < nodes.length; i++) {
                for (let j = 0; j < nodes.length; j++) {
                    if (i === j) continue;

                    const container = nodes[i];
                    const element = nodes[j];

                    const containerBounds = getElementBounds(container);
                    const elementBounds = getElementBounds(element);

                    if (isElementContained(containerBounds, elementBounds)) {
                        containmentRelations.push({
                            parent: container.id,
                            child: element.id,
                            parentNode: container,
                            childNode: element
                        });
                    }
                }
            }

            console.log('ğŸ“¦ åŒ…å«å…³ç³»:', containmentRelations);

            // 2. è¿‡æ»¤å†²çªå…³ç³»
            const validRelations = containmentRelations.filter(relation => {
                const childBounds = getElementBounds(relation.childNode);

                // æ£€æŸ¥æ˜¯å¦ä¸å…¶ä»–åŒçº§å…ƒç´ é‡å 
                const siblings = containmentRelations
                    .filter(r => r.parent === relation.parent && r.child !== relation.child)
                    .map(r => r.childNode);

                return !siblings.some(sibling => {
                    const siblingBounds = getElementBounds(sibling);
                    return hasPartialOverlap(childBounds, siblingBounds);
                });
            });

            // 3. æ„å»ºå±‚æ¬¡ç»“æ„
            const hierarchy = buildHierarchy(validRelations, nodes);

            return hierarchy;
        }

        // æ„å»ºå±‚æ¬¡ç»“æ„
        function buildHierarchy(relations, allNodes) {
            const childrenMap = new Map();
            const parentMap = new Map();

            // æ„å»ºçˆ¶å­æ˜ å°„
            relations.forEach(relation => {
                if (!childrenMap.has(relation.parent)) {
                    childrenMap.set(relation.parent, []);
                }
                childrenMap.get(relation.parent).push(relation.child);
                parentMap.set(relation.child, relation.parent);
            });

            // æ‰¾åˆ°æ ¹èŠ‚ç‚¹ï¼ˆæ²¡æœ‰çˆ¶èŠ‚ç‚¹çš„èŠ‚ç‚¹ï¼‰
            const rootNodes = allNodes.filter(node => !parentMap.has(node.id));

            // æ„å»ºæ ‘å½¢ç»“æ„
            function buildTree(nodeId, depth = 0) {
                const node = allNodes.find(n => n.id === nodeId);
                const children = childrenMap.get(nodeId) || [];

                return {
                    ...node,
                    children: children.map(childId => buildTree(childId, depth + 1)),
                    depth: depth
                };
            }

            return rootNodes.map(root => buildTree(root.id));
        }

        // è®¡ç®—æœ€å°æ“ä½œæ­¥éª¤
        function calculateMinimalOperations(originalNodes, idealStructure) {
            const operations = [];
            const originalMap = new Map(originalNodes.map(n => [n.id, n]));

            // æ‰å¹³åŒ–ç†æƒ³ç»“æ„
            function flattenStructure(nodes, parentId = null) {
                const result = [];
                nodes.forEach(node => {
                    result.push({
                        id: node.id,
                        parent: parentId,
                        node: node
                    });
                    if (node.children && node.children.length > 0) {
                        result.push(...flattenStructure(node.children, node.id));
                    }
                });
                return result;
            }

            const idealFlat = flattenStructure(idealStructure);

            // æ¯”è¾ƒåŸå§‹ç»“æ„å’Œç†æƒ³ç»“æ„
            idealFlat.forEach(idealNode => {
                const originalNode = originalMap.get(idealNode.id);

                if (originalNode.parent !== idealNode.parent) {
                    operations.push({
                        type: 'move',
                        nodeId: idealNode.id,
                        nodeName: originalNode.name,
                        fromParent: originalNode.parent,
                        toParent: idealNode.parent,
                        description: `å°† ${originalNode.name} ä» ${originalNode.parent || 'root'} ç§»åŠ¨åˆ° ${idealNode.parent || 'root'}`
                    });
                }
            });

            // æ£€æŸ¥éœ€è¦åˆ é™¤çš„æ— æ•ˆå…³ç³»
            originalNodes.forEach(node => {
                if (node.parent === null) return;

                const idealNode = idealFlat.find(n => n.id === node.id);
                if (!idealNode) {
                    operations.push({
                        type: 'remove',
                        nodeId: node.id,
                        nodeName: node.name,
                        description: `ç§»é™¤æ— æ•ˆèŠ‚ç‚¹ ${node.name}`
                    });
                }
            });

            return operations;
        }

        // åº”ç”¨æ“ä½œ
        function applyOperations(originalNodes, operations) {
            const result = JSON.parse(JSON.stringify(originalNodes)); // æ·±æ‹·è´

            operations.forEach(operation => {
                const node = result.find(n => n.id === operation.nodeId);
                if (!node) return;

                switch (operation.type) {
                    case 'move':
                        node.parent = operation.toParent;
                        break;
                    case 'remove':
                        const index = result.findIndex(n => n.id === operation.nodeId);
                        if (index !== -1) {
                            result.splice(index, 1);
                        }
                        break;
                }
            });

            return result;
        }

        // è®¡ç®—ä¼˜åŒ–ç»Ÿè®¡
        function calculateOptimizationStats(original, optimized, operations) {
            const originalProblems = analyzeStructureProblems(original);
            const optimizedProblems = analyzeStructureProblems(optimized);

            const originalDepth = calculateMaxDepth(original);
            const optimizedDepth = calculateMaxDepth(optimized);

            const problemsFixed = originalProblems.length - optimizedProblems.length;
            const optimizationRate = originalProblems.length > 0 ?
                (problemsFixed / originalProblems.length * 100).toFixed(1) : 100;

            return {
                originalProblems: originalProblems.length,
                optimizedProblems: optimizedProblems.length,
                problemsFixed: problemsFixed,
                operationCount: operations.length,
                originalDepth: originalDepth,
                optimizedDepth: optimizedDepth,
                optimizationRate: optimizationRate
            };
        }

        // è®¡ç®—æ ‘çš„æœ€å¤§æ·±åº¦
        function calculateMaxDepth(nodes) {
            const nodeMap = new Map(nodes.map(n => [n.id, n]));
            let maxDepth = 0;

            function getDepth(nodeId, visited = new Set()) {
                if (visited.has(nodeId)) return 0; // é¿å…å¾ªç¯å¼•ç”¨
                visited.add(nodeId);

                const node = nodeMap.get(nodeId);
                if (!node || !node.parent) return 1;

                return 1 + getDepth(node.parent, visited);
            }

            nodes.forEach(node => {
                const depth = getDepth(node.id);
                maxDepth = Math.max(maxDepth, depth);
            });

            return maxDepth;
        }

        // æ¸²æŸ“å‡½æ•°
        function renderTreeStructure(nodes, containerId, isOptimized = false) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (!nodes || nodes.length === 0) {
                container.innerHTML = '<div style="color: #6b7280; text-align: center; padding: 20px;">æš‚æ— æ•°æ®</div>';
                return;
            }

            // æ„å»ºæ ‘å½¢æ˜¾ç¤º
            const nodeMap = new Map(nodes.map(n => [n.id, n]));
            const rootNodes = nodes.filter(n => n.parent === null);

            function renderNode(node, depth = 0, isLast = false, prefix = '') {
                const icon = node.type === 'container' ? 'ğŸ“¦' :
                           node.type === 'text' ? 'ğŸ“' :
                           node.type === 'button' ? 'ğŸ”˜' :
                           node.type === 'image' ? 'ğŸ–¼ï¸' : 'âšª';

                // æ„å»ºæ ‘å½¢è¿æ¥çº¿
                const connector = depth === 0 ? '' : (isLast ? 'â””â”€â”€ ' : 'â”œâ”€â”€ ');
                const currentPrefix = prefix + connector;

                // æ·»åŠ èŠ‚ç‚¹ä¿¡æ¯
                const nodeInfo = `${currentPrefix}${icon} ${node.name}`;
                const nodeDetails = isOptimized ?
                    ` <span style="color: #6b7280; font-size: 0.9em;">[${node.type}] (${node.x},${node.y}) ${node.width}Ã—${node.height}</span>` :
                    ` <span style="color: #6b7280; font-size: 0.9em;">(${node.id})</span>`;

                let html = `<div class="tree-node ${isOptimized ? 'valid' : ''}" style="font-family: monospace; line-height: 1.4;">
                    ${nodeInfo}${nodeDetails}
                </div>`;

                // æ¸²æŸ“å­èŠ‚ç‚¹
                const children = nodes.filter(n => n.parent === node.id);
                children.forEach((child, index) => {
                    const isChildLast = index === children.length - 1;
                    const childPrefix = prefix + (depth === 0 ? '' : (isLast ? '    ' : 'â”‚   '));
                    html += renderNode(child, depth + 1, isChildLast, childPrefix);
                });

                return html;
            }

            let treeHtml = '';

            if (isOptimized) {
                // ä¸ºä¼˜åŒ–åçš„ç»“æ„æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
                const stats = calculateTreeStats(nodes);
                treeHtml += `<div style="background: #f0f9ff; padding: 10px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #0ea5e9;">
                    <strong>ğŸŒ³ ä¼˜åŒ–åæ ‘å½¢ç»“æ„</strong><br>
                    <span style="font-size: 0.9em; color: #6b7280;">
                        èŠ‚ç‚¹æ€»æ•°: ${stats.totalNodes} | æœ€å¤§æ·±åº¦: ${stats.maxDepth} | å®¹å™¨æ•°: ${stats.containerCount} | å¶å­èŠ‚ç‚¹: ${stats.leafNodes}
                    </span>
                </div>`;
            }

            rootNodes.forEach((root, index) => {
                const isLast = index === rootNodes.length - 1;
                treeHtml += renderNode(root, 0, isLast);
            });

            // å¦‚æœæ²¡æœ‰æ ¹èŠ‚ç‚¹ï¼Œæ˜¾ç¤ºæ‰€æœ‰èŠ‚ç‚¹ï¼ˆå¯èƒ½æ˜¯æ•°æ®é—®é¢˜ï¼‰
            if (rootNodes.length === 0) {
                treeHtml += '<div style="color: #dc2626; margin-bottom: 10px;">âš ï¸ è­¦å‘Šï¼šæœªæ‰¾åˆ°æ ¹èŠ‚ç‚¹ï¼Œæ˜¾ç¤ºæ‰€æœ‰èŠ‚ç‚¹ï¼š</div>';
                nodes.forEach(node => {
                    treeHtml += renderNode(node, 0, false);
                });
            }

            container.innerHTML = treeHtml;
        }

        // è®¡ç®—æ ‘å½¢ç»“æ„ç»Ÿè®¡ä¿¡æ¯
        function calculateTreeStats(nodes) {
            const containerCount = nodes.filter(n => n.type === 'container').length;
            const leafNodes = nodes.filter(n => !nodes.some(child => child.parent === n.id)).length;
            const maxDepth = calculateMaxDepth(nodes);

            return {
                totalNodes: nodes.length,
                containerCount: containerCount,
                leafNodes: leafNodes,
                maxDepth: maxDepth
            };
        }

        function renderCanvas(nodes, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (!nodes || nodes.length === 0) return;

            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
            const maxX = Math.max(...nodes.map(n => n.x + n.width));
            const maxY = Math.max(...nodes.map(n => n.y + n.height));
            const scale = Math.min(container.clientWidth / maxX, container.clientHeight / maxY, 1) * 0.9;

            nodes.forEach(node => {
                const div = document.createElement('div');
                div.className = `element element-${node.type}`;
                div.style.left = (node.x * scale) + 'px';
                div.style.top = (node.y * scale) + 'px';
                div.style.width = (node.width * scale) + 'px';
                div.style.height = (node.height * scale) + 'px';
                div.textContent = node.name.length > 8 ? node.name.substring(0, 8) + '...' : node.name;
                div.title = `${node.name}\nä½ç½®: (${node.x}, ${node.y})\nå°ºå¯¸: ${node.width} Ã— ${node.height}\nçˆ¶èŠ‚ç‚¹: ${node.parent || 'root'}`;
                container.appendChild(div);
            });
        }

        function renderOperations(operations) {
            const container = document.getElementById('operations-list');
            container.innerHTML = '';

            if (operations.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 20px;">æ— éœ€æ“ä½œï¼Œç»“æ„å·²ä¼˜åŒ–</div>';
                return;
            }

            operations.forEach((operation, index) => {
                const div = document.createElement('div');
                div.className = `operation-step ${operation.type}`;

                const stepNumber = document.createElement('div');
                stepNumber.className = `step-number ${operation.type}`;
                stepNumber.textContent = index + 1;

                const title = document.createElement('div');
                title.className = 'operation-title';
                title.textContent = `${operation.type === 'move' ? 'ğŸ”„ ç§»åŠ¨èŠ‚ç‚¹' :
                                   operation.type === 'remove' ? 'ğŸ—‘ï¸ åˆ é™¤èŠ‚ç‚¹' :
                                   'â• æ·»åŠ èŠ‚ç‚¹'}`;

                const details = document.createElement('div');
                details.className = 'operation-details';
                details.textContent = operation.description;

                div.appendChild(stepNumber);
                div.appendChild(title);
                div.appendChild(details);
                container.appendChild(div);
            });
        }

        function renderAnalysis(problems) {
            const container = document.getElementById('analysis-result');
            container.innerHTML = '';

            if (problems.length === 0) {
                container.innerHTML = '<div style="color: #059669; text-align: center; padding: 20px;">âœ… ç»“æ„å®Œç¾ï¼Œæ— é—®é¢˜å‘ç°</div>';
                return;
            }

            let analysisHtml = `<div style="margin-bottom: 15px; font-weight: 600; color: #dc2626;">å‘ç° ${problems.length} ä¸ªé—®é¢˜:</div>`;

            problems.forEach((problem, index) => {
                const icon = problem.type === 'geometric_mismatch' ? 'ğŸ“' :
                           problem.type === 'missing_parent' ? 'ğŸ”—' :
                           problem.type === 'sibling_overlap' ? 'âš ï¸' : 'â“';

                analysisHtml += `<div style="margin: 8px 0; padding: 8px; background: #fef2f2; border-radius: 4px; border-left: 3px solid #ef4444;">
                    <strong>${icon} é—®é¢˜ ${index + 1}:</strong><br>
                    <span style="font-size: 0.9em; color: #6b7280;">${problem.description}</span>
                </div>`;
            });

            container.innerHTML = analysisHtml;
        }

        function updateStats(stats) {
            document.getElementById('total-nodes').textContent = stats.originalProblems + stats.optimizedProblems || 0;
            document.getElementById('invalid-relations').textContent = stats.originalProblems || 0;
            document.getElementById('operation-count').textContent = stats.operationCount || 0;
            document.getElementById('tree-depth').textContent = `${stats.originalDepth || 0} â†’ ${stats.optimizedDepth || 0}`;
            document.getElementById('optimization-score').textContent = (stats.optimizationRate || 0) + '%';
        }

        // æ¸²æŸ“ä¼˜åŒ–å¯¹æ¯”
        function renderOptimizationComparison(originalNodes, optimizedNodes) {
            document.getElementById('comparison-section').style.display = 'block';

            // æ¸²æŸ“åŸå§‹å±‚æ¬¡ç»“æ„
            renderHierarchyText(originalNodes, 'original-hierarchy');

            // æ¸²æŸ“ä¼˜åŒ–åå±‚æ¬¡ç»“æ„
            renderHierarchyText(optimizedNodes, 'optimized-hierarchy');
        }

        // æ¸²æŸ“æ–‡æœ¬å½¢å¼çš„å±‚æ¬¡ç»“æ„
        function renderHierarchyText(nodes, containerId) {
            const container = document.getElementById(containerId);

            if (!nodes || nodes.length === 0) {
                container.innerHTML = '<div style="color: #6b7280;">æš‚æ— æ•°æ®</div>';
                return;
            }

            const rootNodes = nodes.filter(n => n.parent === null);

            function buildHierarchyText(node, depth = 0, isLast = false, prefix = '') {
                const icon = node.type === 'container' ? 'ğŸ“¦' :
                           node.type === 'text' ? 'ğŸ“' :
                           node.type === 'button' ? 'ğŸ”˜' :
                           node.type === 'image' ? 'ğŸ–¼ï¸' : 'âšª';

                const connector = depth === 0 ? '' : (isLast ? 'â””â”€â”€ ' : 'â”œâ”€â”€ ');
                const currentPrefix = prefix + connector;

                let text = `${currentPrefix}${icon} ${node.name}\n`;

                // æ·»åŠ å­èŠ‚ç‚¹
                const children = nodes.filter(n => n.parent === node.id);
                children.forEach((child, index) => {
                    const isChildLast = index === children.length - 1;
                    const childPrefix = prefix + (depth === 0 ? '' : (isLast ? '    ' : 'â”‚   '));
                    text += buildHierarchyText(child, depth + 1, isChildLast, childPrefix);
                });

                return text;
            }

            let hierarchyText = '';
            rootNodes.forEach((root, index) => {
                const isLast = index === rootNodes.length - 1;
                hierarchyText += buildHierarchyText(root, 0, isLast);
            });

            // å¦‚æœæ²¡æœ‰æ ¹èŠ‚ç‚¹
            if (rootNodes.length === 0) {
                hierarchyText = 'âš ï¸ æœªæ‰¾åˆ°æ ¹èŠ‚ç‚¹\n\næ‰€æœ‰èŠ‚ç‚¹:\n';
                nodes.forEach(node => {
                    hierarchyText += `${node.type === 'container' ? 'ğŸ“¦' : 'âšª'} ${node.name} (parent: ${node.parent || 'null'})\n`;
                });
            }

            container.textContent = hierarchyText;
        }

        // äº‹ä»¶å¤„ç†
        function initEventListeners() {
            // ç¤ºä¾‹æŒ‰é’®
            document.querySelectorAll('.example-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const example = examples[btn.dataset.example];
                    document.getElementById('input-data').value = JSON.stringify(example, null, 2);
                });
            });

            // è§£ææŒ‰é’®
            document.getElementById('parse-btn').addEventListener('click', () => {
                try {
                    const inputData = document.getElementById('input-data').value;
                    currentData = JSON.parse(inputData);

                    renderTreeStructure(currentData, 'original-tree');
                    renderCanvas(currentData, 'original-canvas');

                    const problems = analyzeStructureProblems(currentData);
                    renderAnalysis(problems);

                    document.getElementById('total-nodes').textContent = currentData.length;
                    document.getElementById('invalid-relations').textContent = problems.length;

                    console.log('âœ… æ•°æ®è§£ææˆåŠŸ');
                } catch (error) {
                    alert('æ•°æ®æ ¼å¼é”™è¯¯: ' + error.message);
                }
            });

            // ä¼˜åŒ–æŒ‰é’®
            document.getElementById('optimize-btn').addEventListener('click', () => {
                if (!currentData) {
                    alert('è¯·å…ˆè§£ææ•°æ®');
                    return;
                }

                try {
                    const result = optimizeTreeStructure(currentData);

                    renderTreeStructure(result.optimizedNodes, 'optimized-tree', true);
                    renderCanvas(result.optimizedNodes, 'optimized-canvas');
                    renderOperations(result.operations);
                    updateStats(result.stats);

                    // æ˜¾ç¤ºä¼˜åŒ–å¯¹æ¯”
                    renderOptimizationComparison(currentData, result.optimizedNodes);

                    console.log('âœ… ä¼˜åŒ–å®Œæˆ', result);
                } catch (error) {
                    alert('ä¼˜åŒ–å¤±è´¥: ' + error.message);
                    console.error(error);
                }
            });

            // æ¸…ç©ºæŒ‰é’®
            document.getElementById('clear-btn').addEventListener('click', () => {
                document.getElementById('input-data').value = '';
                currentData = null;

                ['original-tree', 'optimized-tree', 'analysis-result', 'operations-list'].forEach(id => {
                    document.getElementById(id).innerHTML = '';
                });

                ['original-canvas', 'optimized-canvas'].forEach(id => {
                    document.getElementById(id).innerHTML = '';
                });

                ['total-nodes', 'invalid-relations', 'operation-count', 'tree-depth', 'optimization-score'].forEach(id => {
                    document.getElementById(id).textContent = '0';
                });
            });
        }

        // åˆå§‹åŒ–
        function init() {
            initEventListeners();
            console.log('ğŸŒ³ é€šç”¨æ ‘å½¢ç»“æ„ä¼˜åŒ–å™¨å·²åŠ è½½');
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
